(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

(* StructRecord
  {
    name := "Account";
    ty_params := [];
    fields := [ ("id", Ty.path "i32"); ("balance", Ty.path "u32") ];
  } *)

(* StructRecord
  {
    name := "Bank";
    ty_params := [];
    fields :=
      [
        ("accounts",
          Ty.apply
            (Ty.path "alloc::vec::Vec")
            [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global" ])
      ];
  } *)

Module Impl_small_bank_Bank.
  Definition Self : Ty.t := Ty.path "small_bank::Bank".
  
  (*
      fn transfer(&mut self, from: i32, to: i32, amount: u32) {
          let from_index = self.accounts.iter().position(|&x| x.id == from);
          let to_index = self.accounts.iter().position(|&x| x.id == to);
          if from_index.is_none() || to_index.is_none() {
              return;
          }
          let from_index = from_index.unwrap();
          let to_index = to_index.unwrap();
          if self.accounts[from_index].balance < amount {
              return;
          }
          self.accounts[from_index].balance -= amount;
          self.accounts[to_index].balance += amount;
      }
  *)
  Definition transfer (ðœ : list Ty.t) (Î± : list Value.t) : M :=
    match ðœ, Î± with
    | [], [ self; from; to; amount ] =>
      let* self := M.alloc self in
      let* from := M.alloc from in
      let* to := M.alloc to in
      let* amount := M.alloc amount in
      let* from_index :=
        let* Î±0 :=
          M.get_trait_method
            "core::iter::traits::iterator::Iterator"
            (Ty.apply
              (Ty.path "core::slice::iter::Iter")
              [ Ty.path "small_bank::Account" ])
            []
            "position"
            [
              Ty.function
                [
                  Ty.tuple
                    [ Ty.apply (Ty.path "&") [ Ty.path "small_bank::Account" ] ]
                ]
                (Ty.path "bool")
            ] in
        let* Î±1 :=
          M.get_associated_function
            (Ty.apply (Ty.path "slice") [ Ty.path "small_bank::Account" ])
            "iter"
            [] in
        let* Î±2 :=
          M.get_trait_method
            "core::ops::deref::Deref"
            (Ty.apply
              (Ty.path "alloc::vec::Vec")
              [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global" ])
            []
            "deref"
            [] in
        let* Î±3 := M.read self in
        let* Î±4 :=
          M.call_closure
            Î±2
            [ M.get_struct_record_field Î±3 "small_bank::Bank" "accounts" ] in
        let* Î±5 := M.call_closure Î±1 [ Î±4 ] in
        let* Î±6 := M.alloc Î±5 in
        let* Î±7 :=
          M.call_closure
            Î±0
            [
              Î±6;
              M.closure
                (fun Î³ =>
                  match Î³ with
                  | [ Î±0 ] =>
                    let* Î±0 := M.alloc Î±0 in
                    match_operator
                      Î±0
                      [
                        fun Î³ =>
                          let* Î³ := M.read Î³ in
                          let* x := M.copy Î³ in
                          let* Î±0 :=
                            M.read
                              (M.get_struct_record_field
                                x
                                "small_bank::Account"
                                "id") in
                          let* Î±1 := M.read from in
                          M.pure (BinOp.Pure.eq Î±0 Î±1)
                      ]
                  | _ => M.impossible
                  end)
            ] in
        M.alloc Î±7 in
      let* to_index :=
        let* Î±0 :=
          M.get_trait_method
            "core::iter::traits::iterator::Iterator"
            (Ty.apply
              (Ty.path "core::slice::iter::Iter")
              [ Ty.path "small_bank::Account" ])
            []
            "position"
            [
              Ty.function
                [
                  Ty.tuple
                    [ Ty.apply (Ty.path "&") [ Ty.path "small_bank::Account" ] ]
                ]
                (Ty.path "bool")
            ] in
        let* Î±1 :=
          M.get_associated_function
            (Ty.apply (Ty.path "slice") [ Ty.path "small_bank::Account" ])
            "iter"
            [] in
        let* Î±2 :=
          M.get_trait_method
            "core::ops::deref::Deref"
            (Ty.apply
              (Ty.path "alloc::vec::Vec")
              [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global" ])
            []
            "deref"
            [] in
        let* Î±3 := M.read self in
        let* Î±4 :=
          M.call_closure
            Î±2
            [ M.get_struct_record_field Î±3 "small_bank::Bank" "accounts" ] in
        let* Î±5 := M.call_closure Î±1 [ Î±4 ] in
        let* Î±6 := M.alloc Î±5 in
        let* Î±7 :=
          M.call_closure
            Î±0
            [
              Î±6;
              M.closure
                (fun Î³ =>
                  match Î³ with
                  | [ Î±0 ] =>
                    let* Î±0 := M.alloc Î±0 in
                    match_operator
                      Î±0
                      [
                        fun Î³ =>
                          let* Î³ := M.read Î³ in
                          let* x := M.copy Î³ in
                          let* Î±0 :=
                            M.read
                              (M.get_struct_record_field
                                x
                                "small_bank::Account"
                                "id") in
                          let* Î±1 := M.read to in
                          M.pure (BinOp.Pure.eq Î±0 Î±1)
                      ]
                  | _ => M.impossible
                  end)
            ] in
        M.alloc Î±7 in
      let* _ :=
        let* Î±0 :=
          M.get_associated_function
            (Ty.apply (Ty.path "core::option::Option") [ Ty.path "usize" ])
            "is_none"
            [] in
        let* Î±1 := M.call_closure Î±0 [ from_index ] in
        let* Î±2 :=
          LogicalOp.or
            Î±1
            (let* Î±0 :=
              M.get_associated_function
                (Ty.apply (Ty.path "core::option::Option") [ Ty.path "usize" ])
                "is_none"
                [] in
            M.call_closure Î±0 [ to_index ]) in
        let* Î±3 := M.alloc Î±2 in
        let* Î±4 := M.read (M.use Î±3) in
        if Value.is_true Î±4 then
          let* Î±0 := M.return_ (Value.Tuple []) in
          let* Î±1 := M.read Î±0 in
          let* Î±2 := M.never_to_any Î±1 in
          M.alloc Î±2
        else
          M.alloc (Value.Tuple []) in
      let* from_index :=
        let* Î±0 :=
          M.get_associated_function
            (Ty.apply (Ty.path "core::option::Option") [ Ty.path "usize" ])
            "unwrap"
            [] in
        let* Î±1 := M.read from_index in
        let* Î±2 := M.call_closure Î±0 [ Î±1 ] in
        M.alloc Î±2 in
      let* to_index :=
        let* Î±0 :=
          M.get_associated_function
            (Ty.apply (Ty.path "core::option::Option") [ Ty.path "usize" ])
            "unwrap"
            [] in
        let* Î±1 := M.read to_index in
        let* Î±2 := M.call_closure Î±0 [ Î±1 ] in
        M.alloc Î±2 in
      let* _ :=
        let* Î±0 :=
          M.get_trait_method
            "core::ops::index::Index"
            (Ty.apply
              (Ty.path "alloc::vec::Vec")
              [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global" ])
            [ Ty.path "usize" ]
            "index"
            [] in
        let* Î±1 := M.read self in
        let* Î±2 := M.read from_index in
        let* Î±3 :=
          M.call_closure
            Î±0
            [ M.get_struct_record_field Î±1 "small_bank::Bank" "accounts"; Î±2
            ] in
        let* Î±4 :=
          M.read
            (M.get_struct_record_field Î±3 "small_bank::Account" "balance") in
        let* Î±5 := M.read amount in
        let* Î±6 := M.alloc (BinOp.Pure.lt Î±4 Î±5) in
        let* Î±7 := M.read (M.use Î±6) in
        if Value.is_true Î±7 then
          let* Î±0 := M.return_ (Value.Tuple []) in
          let* Î±1 := M.read Î±0 in
          let* Î±2 := M.never_to_any Î±1 in
          M.alloc Î±2
        else
          M.alloc (Value.Tuple []) in
      let* _ :=
        let* Î² :=
          let* Î±0 :=
            M.get_trait_method
              "core::ops::index::IndexMut"
              (Ty.apply
                (Ty.path "alloc::vec::Vec")
                [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global"
                ])
              [ Ty.path "usize" ]
              "index_mut"
              [] in
          let* Î±1 := M.read self in
          let* Î±2 := M.read from_index in
          let* Î±3 :=
            M.call_closure
              Î±0
              [ M.get_struct_record_field Î±1 "small_bank::Bank" "accounts"; Î±2
              ] in
          M.pure
            (M.get_struct_record_field Î±3 "small_bank::Account" "balance") in
        let* Î±0 := M.read Î² in
        let* Î±1 := M.read amount in
        let* Î±2 := BinOp.Panic.sub Î±0 Î±1 in
        M.assign Î² Î±2 in
      let* _ :=
        let* Î² :=
          let* Î±0 :=
            M.get_trait_method
              "core::ops::index::IndexMut"
              (Ty.apply
                (Ty.path "alloc::vec::Vec")
                [ Ty.path "small_bank::Account"; Ty.path "alloc::alloc::Global"
                ])
              [ Ty.path "usize" ]
              "index_mut"
              [] in
          let* Î±1 := M.read self in
          let* Î±2 := M.read to_index in
          let* Î±3 :=
            M.call_closure
              Î±0
              [ M.get_struct_record_field Î±1 "small_bank::Bank" "accounts"; Î±2
              ] in
          M.pure
            (M.get_struct_record_field Î±3 "small_bank::Account" "balance") in
        let* Î±0 := M.read Î² in
        let* Î±1 := M.read amount in
        let* Î±2 := BinOp.Panic.add Î±0 Î±1 in
        M.assign Î² Î±2 in
      let* Î±0 := M.alloc (Value.Tuple []) in
      M.read Î±0
    | _, _ => M.impossible
    end.
  
  Axiom AssociatedFunction_transfer :
    M.IsAssociatedFunction Self "transfer" transfer.
End Impl_small_bank_Bank.
