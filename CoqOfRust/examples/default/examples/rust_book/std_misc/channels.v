(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

Definition NTHREADS : Value.t :=
  M.run
    (let* Î±0 := M.alloc (Value.Integer Integer.I32 3) in
    M.alloc Î±0).

(*
fn main() {
    // Channels have two endpoints: the `Sender<T>` and the `Receiver<T>`,
    // where `T` is the type of the message to be transferred
    // (type annotation is superfluous)
    let (tx, rx): (Sender<i32>, Receiver<i32>) = mpsc::channel();
    let mut children = Vec::new();

    for id in 0..NTHREADS {
        // The sender endpoint can be copied
        let thread_tx = tx.clone();

        // Each thread will send its id via the channel
        let child = thread::spawn(move || {
            // The thread takes ownership over `thread_tx`
            // Each thread queues a message in the channel
            thread_tx.send(id).unwrap();

            // Sending is a non-blocking operation, the thread will continue
            // immediately after sending its message
            println!("thread {} finished", id);
        });

        children.push(child);
    }

    // Here, all the messages are collected
    let mut ids = Vec::with_capacity(NTHREADS as usize);
    for _ in 0..NTHREADS {
        // The `recv` method picks a message from the channel
        // `recv` will block the current thread if there are no messages available
        ids.push(rx.recv());
    }

    // Wait for the threads to complete any remaining work
    for child in children {
        child.join().expect("oops! the child thread panicked");
    }

    // Show the order in which the messages were sent
    println!("{:?}", ids);
}
*)
(* #[allow(dead_code)] - function was ignored by the compiler *)
Definition main (ðœ : list Ty.t) (Î± : list Value.t) : M :=
  match ðœ, Î± with
  | [], [] =>
    let* Î±0 := M.get_function "std::sync::mpsc::channel" [ Ty.path "i32" ] in
    let* Î±1 := M.call Î±0 [] in
    let* Î±2 := M.alloc Î±1 in
    let* Î±3 :=
      match_operator
        Î±2
        [
          fun Î³ =>
            (let* Î³0_0 := M.get_tuple_field_or_break_match Î³ 0 in
            let* Î³0_1 := M.get_tuple_field_or_break_match Î³ 1 in
            let* tx := M.copy Î³0_0 in
            let* rx := M.copy Î³0_1 in
            let* children :=
              let* Î±0 :=
                M.get_associated_function
                  (Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    [
                      Ty.apply
                        (Ty.path "std::thread::JoinHandle")
                        [ Ty.tuple [] ];
                      Ty.path "alloc::alloc::Global"
                    ])
                  "new" in
              let* Î±1 := M.call Î±0 [] in
              M.alloc Î±1 in
            let* _ :=
              let* Î±0 :=
                M.get_trait_method
                  "core::iter::traits::collect::IntoIterator"
                  "into_iter"
                  [
                    (* Self *)
                      Ty.apply
                        (Ty.path "core::ops::range::Range")
                        [ Ty.path "i32" ]
                  ] in
              let* Î±1 := M.var "channels::NTHREADS" in
              let* Î±2 := M.read Î±1 in
              let* Î±3 := M.read Î±2 in
              let* Î±4 :=
                M.call
                  Î±0
                  [
                    Value.StructRecord
                      "core::ops::range::Range"
                      [ ("start", Value.Integer Integer.I32 0); ("end_", Î±3) ]
                  ] in
              let* Î±5 := M.alloc Î±4 in
              let* Î±6 :=
                match_operator
                  Î±5
                  [
                    fun Î³ =>
                      (let* iter := M.copy Î³ in
                      M.loop
                        (let* _ :=
                          let* Î±0 :=
                            M.get_trait_method
                              "core::iter::traits::iterator::Iterator"
                              "next"
                              [
                                (* Self *)
                                  Ty.apply
                                    (Ty.path "core::ops::range::Range")
                                    [ Ty.path "i32" ]
                              ] in
                          let* Î±1 := M.call Î±0 [ iter ] in
                          let* Î±2 := M.alloc Î±1 in
                          match_operator
                            Î±2
                            [
                              fun Î³ =>
                                (let* Î±0 := M.break in
                                let* Î±1 := M.read Î±0 in
                                let* Î±2 := M.never_to_any Î±1 in
                                M.alloc Î±2);
                              fun Î³ =>
                                (let* Î³0_0 :=
                                  M.get_struct_tuple_field_or_break_match
                                    Î³
                                    "core::option::Option::Some"
                                    0 in
                                let* id := M.copy Î³0_0 in
                                let* thread_tx :=
                                  let* Î±0 :=
                                    M.get_trait_method
                                      "core::clone::Clone"
                                      "clone"
                                      [
                                        (* Self *)
                                          Ty.apply
                                            (Ty.path "std::sync::mpsc::Sender")
                                            [ Ty.path "i32" ]
                                      ] in
                                  let* Î±1 := M.call Î±0 [ tx ] in
                                  M.alloc Î±1 in
                                let* child :=
                                  let* Î±0 :=
                                    M.get_function
                                      "std::thread::spawn"
                                      [
                                        Ty.function
                                          [ Ty.tuple [] ]
                                          (Ty.tuple []);
                                        Ty.tuple []
                                      ] in
                                  let* Î±1 :=
                                    M.call
                                      Î±0
                                      [
                                        fun Î±0 (* : Ty.path "unit" *) =>
                                          (let* Î±0 := M.alloc Î±0 in
                                          match_operator
                                            Î±0
                                            [
                                              fun Î³ =>
                                                (let* _ :=
                                                  let* Î±0 :=
                                                    M.get_associated_function
                                                      (Ty.apply
                                                        (Ty.path
                                                          "core::result::Result")
                                                        [
                                                          Ty.tuple [];
                                                          Ty.apply
                                                            (Ty.path
                                                              "std::sync::mpsc::SendError")
                                                            [ Ty.path "i32" ]
                                                        ])
                                                      "unwrap" in
                                                  let* Î±1 :=
                                                    M.get_associated_function
                                                      (Ty.apply
                                                        (Ty.path
                                                          "std::sync::mpsc::Sender")
                                                        [ Ty.path "i32" ])
                                                      "send" in
                                                  let* Î±2 := M.read id in
                                                  let* Î±3 :=
                                                    M.call
                                                      Î±1
                                                      [ thread_tx; Î±2 ] in
                                                  let* Î±4 := M.call Î±0 [ Î±3 ] in
                                                  M.alloc Î±4 in
                                                let* _ :=
                                                  let* _ :=
                                                    let* Î±0 :=
                                                      M.get_function
                                                        "std::io::stdio::_print"
                                                        [] in
                                                    let* Î±1 :=
                                                      M.get_associated_function
                                                        (Ty.path
                                                          "core::fmt::Arguments")
                                                        "new_v1" in
                                                    let* Î±2 :=
                                                      M.read
                                                        (mk_str "thread ") in
                                                    let* Î±3 :=
                                                      M.read
                                                        (mk_str " finished
") in
                                                    let* Î±4 :=
                                                      M.alloc
                                                        (Value.Array
                                                          [ Î±2; Î±3 ]) in
                                                    let* Î±5 :=
                                                      M.get_associated_function
                                                        (Ty.path
                                                          "core::fmt::rt::Argument")
                                                        "new_display" in
                                                    let* Î±6 :=
                                                      M.call Î±5 [ id ] in
                                                    let* Î±7 :=
                                                      M.alloc
                                                        (Value.Array [ Î±6 ]) in
                                                    let* Î±8 :=
                                                      M.call
                                                        Î±1
                                                        [
                                                          M.pointer_coercion
                                                            (* Unsize *)
                                                            Î±4;
                                                          M.pointer_coercion
                                                            (* Unsize *)
                                                            Î±7
                                                        ] in
                                                    let* Î±9 :=
                                                      M.call Î±0 [ Î±8 ] in
                                                    M.alloc Î±9 in
                                                  M.alloc (Value.Tuple []) in
                                                let* Î±0 :=
                                                  M.alloc (Value.Tuple []) in
                                                M.read Î±0)
                                            ])
                                      ] in
                                  M.alloc Î±1 in
                                let* _ :=
                                  let* Î±0 :=
                                    M.get_associated_function
                                      (Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        [
                                          Ty.apply
                                            (Ty.path "std::thread::JoinHandle")
                                            [ Ty.tuple [] ];
                                          Ty.path "alloc::alloc::Global"
                                        ])
                                      "push" in
                                  let* Î±1 := M.read child in
                                  let* Î±2 := M.call Î±0 [ children; Î±1 ] in
                                  M.alloc Î±2 in
                                M.alloc (Value.Tuple []))
                            ] in
                        M.alloc (Value.Tuple [])))
                  ] in
              M.pure (M.use Î±6) in
            let* ids :=
              let* Î±0 :=
                M.get_associated_function
                  (Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    [
                      Ty.apply
                        (Ty.path "core::result::Result")
                        [ Ty.path "i32"; Ty.path "std::sync::mpsc::RecvError" ];
                      Ty.path "alloc::alloc::Global"
                    ])
                  "with_capacity" in
              let* Î±1 := M.var "channels::NTHREADS" in
              let* Î±2 := M.read Î±1 in
              let* Î±3 := M.read Î±2 in
              let* Î±4 := M.call Î±0 [ M.rust_cast Î±3 ] in
              M.alloc Î±4 in
            let* _ :=
              let* Î±0 :=
                M.get_trait_method
                  "core::iter::traits::collect::IntoIterator"
                  "into_iter"
                  [
                    (* Self *)
                      Ty.apply
                        (Ty.path "core::ops::range::Range")
                        [ Ty.path "i32" ]
                  ] in
              let* Î±1 := M.var "channels::NTHREADS" in
              let* Î±2 := M.read Î±1 in
              let* Î±3 := M.read Î±2 in
              let* Î±4 :=
                M.call
                  Î±0
                  [
                    Value.StructRecord
                      "core::ops::range::Range"
                      [ ("start", Value.Integer Integer.I32 0); ("end_", Î±3) ]
                  ] in
              let* Î±5 := M.alloc Î±4 in
              let* Î±6 :=
                match_operator
                  Î±5
                  [
                    fun Î³ =>
                      (let* iter := M.copy Î³ in
                      M.loop
                        (let* _ :=
                          let* Î±0 :=
                            M.get_trait_method
                              "core::iter::traits::iterator::Iterator"
                              "next"
                              [
                                (* Self *)
                                  Ty.apply
                                    (Ty.path "core::ops::range::Range")
                                    [ Ty.path "i32" ]
                              ] in
                          let* Î±1 := M.call Î±0 [ iter ] in
                          let* Î±2 := M.alloc Î±1 in
                          match_operator
                            Î±2
                            [
                              fun Î³ =>
                                (let* Î±0 := M.break in
                                let* Î±1 := M.read Î±0 in
                                let* Î±2 := M.never_to_any Î±1 in
                                M.alloc Î±2);
                              fun Î³ =>
                                (let* Î³0_0 :=
                                  M.get_struct_tuple_field_or_break_match
                                    Î³
                                    "core::option::Option::Some"
                                    0 in
                                let* _ :=
                                  let* Î±0 :=
                                    M.get_associated_function
                                      (Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        [
                                          Ty.apply
                                            (Ty.path "core::result::Result")
                                            [
                                              Ty.path "i32";
                                              Ty.path
                                                "std::sync::mpsc::RecvError"
                                            ];
                                          Ty.path "alloc::alloc::Global"
                                        ])
                                      "push" in
                                  let* Î±1 :=
                                    M.get_associated_function
                                      (Ty.apply
                                        (Ty.path "std::sync::mpsc::Receiver")
                                        [ Ty.path "i32" ])
                                      "recv" in
                                  let* Î±2 := M.call Î±1 [ rx ] in
                                  let* Î±3 := M.call Î±0 [ ids; Î±2 ] in
                                  M.alloc Î±3 in
                                M.alloc (Value.Tuple []))
                            ] in
                        M.alloc (Value.Tuple [])))
                  ] in
              M.pure (M.use Î±6) in
            let* _ :=
              let* Î±0 :=
                M.get_trait_method
                  "core::iter::traits::collect::IntoIterator"
                  "into_iter"
                  [
                    (* Self *)
                      Ty.apply
                        (Ty.path "alloc::vec::Vec")
                        [
                          Ty.apply
                            (Ty.path "std::thread::JoinHandle")
                            [ Ty.tuple [] ];
                          Ty.path "alloc::alloc::Global"
                        ]
                  ] in
              let* Î±1 := M.read children in
              let* Î±2 := M.call Î±0 [ Î±1 ] in
              let* Î±3 := M.alloc Î±2 in
              let* Î±4 :=
                match_operator
                  Î±3
                  [
                    fun Î³ =>
                      (let* iter := M.copy Î³ in
                      M.loop
                        (let* _ :=
                          let* Î±0 :=
                            M.get_trait_method
                              "core::iter::traits::iterator::Iterator"
                              "next"
                              [
                                (* Self *)
                                  Ty.apply
                                    (Ty.path "alloc::vec::into_iter::IntoIter")
                                    [
                                      Ty.apply
                                        (Ty.path "std::thread::JoinHandle")
                                        [ Ty.tuple [] ];
                                      Ty.path "alloc::alloc::Global"
                                    ]
                              ] in
                          let* Î±1 := M.call Î±0 [ iter ] in
                          let* Î±2 := M.alloc Î±1 in
                          match_operator
                            Î±2
                            [
                              fun Î³ =>
                                (let* Î±0 := M.break in
                                let* Î±1 := M.read Î±0 in
                                let* Î±2 := M.never_to_any Î±1 in
                                M.alloc Î±2);
                              fun Î³ =>
                                (let* Î³0_0 :=
                                  M.get_struct_tuple_field_or_break_match
                                    Î³
                                    "core::option::Option::Some"
                                    0 in
                                let* child := M.copy Î³0_0 in
                                let* _ :=
                                  let* Î±0 :=
                                    M.get_associated_function
                                      (Ty.apply
                                        (Ty.path "core::result::Result")
                                        [
                                          Ty.tuple [];
                                          Ty.apply
                                            (Ty.path "alloc::boxed::Box")
                                            [
                                              Ty.dyn
                                                [ ("core::any::Any::Trait", [])
                                                ];
                                              Ty.path "alloc::alloc::Global"
                                            ]
                                        ])
                                      "expect" in
                                  let* Î±1 :=
                                    M.get_associated_function
                                      (Ty.apply
                                        (Ty.path "std::thread::JoinHandle")
                                        [ Ty.tuple [] ])
                                      "join" in
                                  let* Î±2 := M.read child in
                                  let* Î±3 := M.call Î±1 [ Î±2 ] in
                                  let* Î±4 :=
                                    M.read
                                      (mk_str
                                        "oops! the child thread panicked") in
                                  let* Î±5 := M.call Î±0 [ Î±3; Î±4 ] in
                                  M.alloc Î±5 in
                                M.alloc (Value.Tuple []))
                            ] in
                        M.alloc (Value.Tuple [])))
                  ] in
              M.pure (M.use Î±4) in
            let* _ :=
              let* _ :=
                let* Î±0 := M.get_function "std::io::stdio::_print" [] in
                let* Î±1 :=
                  M.get_associated_function
                    (Ty.path "core::fmt::Arguments")
                    "new_v1" in
                let* Î±2 := M.read (mk_str "") in
                let* Î±3 := M.read (mk_str "
") in
                let* Î±4 := M.alloc (Value.Array [ Î±2; Î±3 ]) in
                let* Î±5 :=
                  M.get_associated_function
                    (Ty.path "core::fmt::rt::Argument")
                    "new_debug" in
                let* Î±6 := M.call Î±5 [ ids ] in
                let* Î±7 := M.alloc (Value.Array [ Î±6 ]) in
                let* Î±8 :=
                  M.call
                    Î±1
                    [
                      M.pointer_coercion (* Unsize *) Î±4;
                      M.pointer_coercion (* Unsize *) Î±7
                    ] in
                let* Î±9 := M.call Î±0 [ Î±8 ] in
                M.alloc Î±9 in
              M.alloc (Value.Tuple []) in
            M.alloc (Value.Tuple []))
        ] in
    M.read Î±3
  | _, _ => M.impossible
  end.
