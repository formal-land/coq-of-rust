(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

(*
fn read_lines<P>(filename: P) -> io::Result<io::Lines<io::BufReader<File>>>
where
    P: AsRef<Path>,
{
    let file = File::open(filename)?;
    Ok(io::BufReader::new(file).lines())
}
*)
Definition read_lines (ðœ : list Ty.t) (Î± : list Value.t) : M :=
  match ðœ, Î± with
  | [ P ], [ filename ] =>
    let* filename := M.alloc filename in
    let return_ :=
      M.return_
        (R :=
          Ty.apply
            (Ty.path "core::result::Result")
            [
              Ty.apply
                (Ty.path "std::io::Lines")
                [
                  Ty.apply
                    (Ty.path "std::io::buffered::bufreader::BufReader")
                    [ Ty.path "std::fs::File" ]
                ];
              Ty.path "std::io::error::Error"
            ]) in
    M.catch_return
      (let* file :=
        let* Î±0 :=
          M.get_method
            "core::ops::try_trait::Try"
            "branch"
            [
              (* Self *)
                Ty.apply
                  (Ty.path "core::result::Result")
                  [ Ty.path "std::fs::File"; Ty.path "std::io::error::Error" ]
            ] in
        let* Î±1 := M.read filename in
        let* Î±2 := M.call (Ty.path "std::fs::File")::["open"] [ Î±1 ] in
        let* Î±3 := M.call Î±0 [ Î±2 ] in
        let* Î±4 := M.alloc Î±3 in
        let* Î±5 :=
          match_operator
            Î±4
            [
              fun Î³ =>
                (let* Î±0 := M.read Î³ in
                match Î±0 with
                | core.ops.control_flow.ControlFlow.Break _ =>
                  let* Î³0_0 :=
                    let* Î±0 :=
                      M.var
                        "core::ops::control_flow::ControlFlow::Get_Break_0" in
                    M.pure (Î±0 Î³) in
                  let* residual := M.copy Î³0_0 in
                  let* Î±0 :=
                    M.get_method
                      "core::ops::try_trait::FromResidual"
                      "from_residual"
                      [
                        (* Self *)
                          Ty.apply
                            (Ty.path "core::result::Result")
                            [
                              Ty.apply
                                (Ty.path "std::io::Lines")
                                [
                                  Ty.apply
                                    (Ty.path
                                      "std::io::buffered::bufreader::BufReader")
                                    [ Ty.path "std::fs::File" ]
                                ];
                              Ty.path "std::io::error::Error"
                            ];
                        (* R *)
                          Ty.apply
                            (Ty.path "core::result::Result")
                            [
                              Ty.path "core::convert::Infallible";
                              Ty.path "std::io::error::Error"
                            ]
                      ] in
                  let* Î±1 := M.read residual in
                  let* Î±2 := M.call Î±0 [ Î±1 ] in
                  let* Î±3 := return_ Î±2 in
                  let* Î±4 := M.read Î±3 in
                  let* Î±5 := never_to_any Î±4 in
                  M.alloc Î±5
                | _ => M.break_match 
                end) :
                Ty.path "std::fs::File";
              fun Î³ =>
                (let* Î±0 := M.read Î³ in
                match Î±0 with
                | core.ops.control_flow.ControlFlow.Continue _ =>
                  let* Î³0_0 :=
                    let* Î±0 :=
                      M.var
                        "core::ops::control_flow::ControlFlow::Get_Continue_0" in
                    M.pure (Î±0 Î³) in
                  let* val := M.copy Î³0_0 in
                  M.pure val
                | _ => M.break_match 
                end) :
                Ty.path "std::fs::File"
            ] in
        M.copy Î±5 in
      let* Î±0 :=
        M.get_method
          "std::io::BufRead"
          "lines"
          [
            (* Self *)
              Ty.apply
                (Ty.path "std::io::buffered::bufreader::BufReader")
                [ Ty.path "std::fs::File" ]
          ] in
      let* Î±1 := M.read file in
      let* Î±2 :=
        M.call
          (Ty.apply
              (Ty.path "std::io::buffered::bufreader::BufReader")
              [ Ty.path "std::fs::File" ])::["new"]
          [ Î±1 ] in
      let* Î±3 := M.call Î±0 [ Î±2 ] in
      let* Î±0 :=
        M.alloc (Value.StructTuple "core::result::Result::Ok" [ Î±3 ]) in
      M.read Î±0)
  | _, _ => M.impossible
  end.

(*
fn main() {
    // File hosts must exist in current path before this produces output
    if let Ok(lines) = read_lines("./hosts") {
        // Consumes the iterator, returns an (Optional) String
        for line in lines {
            if let Ok(ip) = line {
                println!("{}", ip);
            }
        }
    }
}
*)
(* #[allow(dead_code)] - function was ignored by the compiler *)
Definition main (ðœ : list Ty.t) (Î± : list Value.t) : M :=
  match ðœ, Î± with
  | [], [] =>
    let* Î±0 := M.var "file_io_read_lines_efficient_method::read_lines" in
    let* Î±1 := M.read (mk_str "./hosts") in
    let* Î±2 := M.call Î±0 [ Î±1 ] in
    let* Î±3 := M.alloc Î±2 in
    let* Î±4 :=
      match_operator
        Î±3
        [
          fun Î³ =>
            (let* Î±0 := M.read Î³ in
            match Î±0 with
            | core.result.Result.Ok _ =>
              let* Î³0_0 :=
                let* Î±0 := M.var "core::result::Result::Get_Ok_0" in
                M.pure (Î±0 Î³) in
              let* lines := M.copy Î³0_0 in
              let* Î±0 :=
                M.get_method
                  "core::iter::traits::collect::IntoIterator"
                  "into_iter"
                  [
                    (* Self *)
                      Ty.apply
                        (Ty.path "std::io::Lines")
                        [
                          Ty.apply
                            (Ty.path "std::io::buffered::bufreader::BufReader")
                            [ Ty.path "std::fs::File" ]
                        ]
                  ] in
              let* Î±1 := M.read lines in
              let* Î±2 := M.call Î±0 [ Î±1 ] in
              let* Î±3 := M.alloc Î±2 in
              let* Î±4 :=
                match_operator
                  Î±3
                  [
                    fun Î³ =>
                      (let* iter := M.copy Î³ in
                      M.loop
                        (let* _ :=
                          let* Î±0 :=
                            M.get_method
                              "core::iter::traits::iterator::Iterator"
                              "next"
                              [
                                (* Self *)
                                  Ty.apply
                                    (Ty.path "std::io::Lines")
                                    [
                                      Ty.apply
                                        (Ty.path
                                          "std::io::buffered::bufreader::BufReader")
                                        [ Ty.path "std::fs::File" ]
                                    ]
                              ] in
                          let* Î±1 := M.call Î±0 [ borrow_mut iter ] in
                          let* Î±2 := M.alloc Î±1 in
                          match_operator
                            Î±2
                            [
                              fun Î³ =>
                                (let* Î±0 := M.read Î³ in
                                match Î±0 with
                                | core.option.Option.None =>
                                  let* Î±0 := M.break in
                                  let* Î±1 := M.read Î±0 in
                                  let* Î±2 := never_to_any Î±1 in
                                  M.alloc Î±2
                                | _ => M.break_match 
                                end) :
                                Ty.tuple [];
                              fun Î³ =>
                                (let* Î±0 := M.read Î³ in
                                match Î±0 with
                                | core.option.Option.Some _ =>
                                  let* Î³0_0 :=
                                    let* Î±0 :=
                                      M.var
                                        "core::option::Option::Get_Some_0" in
                                    M.pure (Î±0 Î³) in
                                  let* line := M.copy Î³0_0 in
                                  match_operator
                                    line
                                    [
                                      fun Î³ =>
                                        (let* Î±0 := M.read Î³ in
                                        match Î±0 with
                                        | core.result.Result.Ok _ =>
                                          let* Î³0_0 :=
                                            let* Î±0 :=
                                              M.var
                                                "core::result::Result::Get_Ok_0" in
                                            M.pure (Î±0 Î³) in
                                          let* ip := M.copy Î³0_0 in
                                          let* _ :=
                                            let* _ :=
                                              let* Î±0 :=
                                                M.var
                                                  "std::io::stdio::_print" in
                                              let* Î±1 := M.read (mk_str "") in
                                              let* Î±2 := M.read (mk_str "
") in
                                              let* Î±3 := M.alloc [ Î±1; Î±2 ] in
                                              let* Î±4 :=
                                                M.call
                                                  (Ty.path
                                                      "core::fmt::rt::Argument")::["new_display"]
                                                  [ borrow ip ] in
                                              let* Î±5 := M.alloc [ Î±4 ] in
                                              let* Î±6 :=
                                                M.call
                                                  (Ty.path
                                                      "core::fmt::Arguments")::["new_v1"]
                                                  [
                                                    pointer_coercion
                                                      "Unsize"
                                                      (borrow Î±3);
                                                    pointer_coercion
                                                      "Unsize"
                                                      (borrow Î±5)
                                                  ] in
                                              let* Î±7 := M.call Î±0 [ Î±6 ] in
                                              M.alloc Î±7 in
                                            M.alloc tt in
                                          M.alloc tt
                                        | _ => M.break_match 
                                        end) :
                                        Ty.tuple [];
                                      fun Î³ => (M.alloc tt) : Ty.path "unit"
                                    ]
                                | _ => M.break_match 
                                end) :
                                Ty.tuple []
                            ] in
                        M.alloc tt)) :
                      Ty.tuple []
                  ] in
              M.pure (use Î±4)
            | _ => M.break_match 
            end) :
            Ty.tuple [];
          fun Î³ => (M.alloc tt) : Ty.path "unit"
        ] in
    M.read Î±4
  | _, _ => M.impossible
  end.
