(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

Module utils.
  (*
  pub fn pack_bits_le<R, Var, I>(iter: I) -> R
  where
      R: PrimeCharacteristicRing,
      Var: Into<R> + Clone,
      I: DoubleEndedIterator<Item = Var>,
  {
      iter.rev()
          .map(Into::into)
          .reduce(|acc, elem| acc.double() + elem)
          .unwrap_or(R::ZERO)
  }
  *)
  Definition pack_bits_le (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ R; Var; _ as I ], [ iter ] =>
      ltac:(M.monadic
        (let iter := M.alloc (| iter |) in
        M.call_closure (|
          R,
          M.get_associated_function (|
            Ty.apply (Ty.path "core::option::Option") [] [ R ],
            "unwrap_or",
            [],
            []
          |),
          [
            M.call_closure (|
              Ty.apply (Ty.path "core::option::Option") [] [ R ],
              M.get_trait_method (|
                "core::iter::traits::iterator::Iterator",
                Ty.apply
                  (Ty.path "core::iter::adapters::map::Map")
                  []
                  [
                    Ty.apply (Ty.path "core::iter::adapters::rev::Rev") [] [ I ];
                    Ty.function [ Var ] R
                  ],
                [],
                [],
                "reduce",
                [],
                [ Ty.function [ Ty.tuple [ R; R ] ] R ]
              |),
              [
                M.call_closure (|
                  Ty.apply
                    (Ty.path "core::iter::adapters::map::Map")
                    []
                    [
                      Ty.apply (Ty.path "core::iter::adapters::rev::Rev") [] [ I ];
                      Ty.function [ Var ] R
                    ],
                  M.get_trait_method (|
                    "core::iter::traits::iterator::Iterator",
                    Ty.apply (Ty.path "core::iter::adapters::rev::Rev") [] [ I ],
                    [],
                    [],
                    "map",
                    [],
                    [ R; Ty.function [ Var ] R ]
                  |),
                  [
                    M.call_closure (|
                      Ty.apply (Ty.path "core::iter::adapters::rev::Rev") [] [ I ],
                      M.get_trait_method (|
                        "core::iter::traits::iterator::Iterator",
                        I,
                        [],
                        [],
                        "rev",
                        [],
                        []
                      |),
                      [ M.read (| iter |) ]
                    |);
                    M.get_trait_method (| "core::convert::Into", Var, [], [ R ], "into", [], [] |)
                  ]
                |);
                M.closure
                  (fun γ =>
                    ltac:(M.monadic
                      match γ with
                      | [ α0; α1 ] =>
                        ltac:(M.monadic
                          (M.match_operator (|
                            Ty.apply (Ty.path "*") [] [ Ty.function [ Ty.tuple [ R; R ] ] R ],
                            M.alloc (| α0 |),
                            [
                              fun γ =>
                                ltac:(M.monadic
                                  (let acc := M.copy (| γ |) in
                                  M.match_operator (|
                                    Ty.apply
                                      (Ty.path "*")
                                      []
                                      [ Ty.function [ Ty.tuple [ R; R ] ] R ],
                                    M.alloc (| α1 |),
                                    [
                                      fun γ =>
                                        ltac:(M.monadic
                                          (let elem := M.copy (| γ |) in
                                          M.call_closure (|
                                            R,
                                            M.get_trait_method (|
                                              "core::ops::arith::Add",
                                              R,
                                              [],
                                              [ R ],
                                              "add",
                                              [],
                                              []
                                            |),
                                            [
                                              M.call_closure (|
                                                R,
                                                M.get_trait_method (|
                                                  "p3_field::field::PrimeCharacteristicRing",
                                                  R,
                                                  [],
                                                  [],
                                                  "double",
                                                  [],
                                                  []
                                                |),
                                                [ M.borrow (| Pointer.Kind.Ref, acc |) ]
                                              |);
                                              M.read (| elem |)
                                            ]
                                          |)))
                                    ]
                                  |)))
                            ]
                          |)))
                      | _ => M.impossible "wrong number of arguments"
                      end))
              ]
            |);
            M.read (| get_constant (| "p3_field::field::PrimeCharacteristicRing::ZERO", R |) |)
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_pack_bits_le :
    M.IsFunction.C "p3_air::utils::pack_bits_le" pack_bits_le.
  Admitted.
  Global Typeclasses Opaque pack_bits_le.
  
  (*
  pub fn checked_xor<F: Field, const N: usize>(xs: &[F]) -> F {
      xs.iter().fold(F::ZERO, |acc, x| {
          debug_assert!(x.is_zero() || x.is_one());
          acc.xor(x)
      })
  }
  *)
  Definition checked_xor (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [ N ], [ F ], [ xs ] =>
      ltac:(M.monadic
        (let xs := M.alloc (| xs |) in
        M.call_closure (|
          F,
          M.get_trait_method (|
            "core::iter::traits::iterator::Iterator",
            Ty.apply (Ty.path "core::slice::iter::Iter") [] [ F ],
            [],
            [],
            "fold",
            [],
            [ F; Ty.function [ Ty.tuple [ F; Ty.apply (Ty.path "&") [] [ F ] ] ] F ]
          |),
          [
            M.call_closure (|
              Ty.apply (Ty.path "core::slice::iter::Iter") [] [ F ],
              M.get_associated_function (| Ty.apply (Ty.path "slice") [] [ F ], "iter", [], [] |),
              [ M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| xs |) |) |) ]
            |);
            M.read (| get_constant (| "p3_field::field::PrimeCharacteristicRing::ZERO", F |) |);
            M.closure
              (fun γ =>
                ltac:(M.monadic
                  match γ with
                  | [ α0; α1 ] =>
                    ltac:(M.monadic
                      (M.match_operator (|
                        Ty.apply
                          (Ty.path "*")
                          []
                          [ Ty.function [ Ty.tuple [ F; Ty.apply (Ty.path "&") [] [ F ] ] ] F ],
                        M.alloc (| α0 |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let acc := M.copy (| γ |) in
                              M.match_operator (|
                                Ty.apply
                                  (Ty.path "*")
                                  []
                                  [
                                    Ty.function
                                      [ Ty.tuple [ F; Ty.apply (Ty.path "&") [] [ F ] ] ]
                                      F
                                  ],
                                M.alloc (| α1 |),
                                [
                                  fun γ =>
                                    ltac:(M.monadic
                                      (let x := M.copy (| γ |) in
                                      M.read (|
                                        let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                          M.match_operator (|
                                            Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
                                            M.alloc (| Value.Tuple [] |),
                                            [
                                              fun γ =>
                                                ltac:(M.monadic
                                                  (let γ := M.use (M.alloc (| Value.Bool true |)) in
                                                  let _ :=
                                                    is_constant_or_break_match (|
                                                      M.read (| γ |),
                                                      Value.Bool true
                                                    |) in
                                                  let~ _ :
                                                      Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                                    M.match_operator (|
                                                      Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
                                                      M.alloc (| Value.Tuple [] |),
                                                      [
                                                        fun γ =>
                                                          ltac:(M.monadic
                                                            (let γ :=
                                                              M.use
                                                                (M.alloc (|
                                                                  UnOp.not (|
                                                                    LogicalOp.or (|
                                                                      M.call_closure (|
                                                                        Ty.path "bool",
                                                                        M.get_trait_method (|
                                                                          "p3_field::field::Field",
                                                                          F,
                                                                          [],
                                                                          [],
                                                                          "is_zero",
                                                                          [],
                                                                          []
                                                                        |),
                                                                        [
                                                                          M.borrow (|
                                                                            Pointer.Kind.Ref,
                                                                            M.deref (|
                                                                              M.read (| x |)
                                                                            |)
                                                                          |)
                                                                        ]
                                                                      |),
                                                                      ltac:(M.monadic
                                                                        (M.call_closure (|
                                                                          Ty.path "bool",
                                                                          M.get_trait_method (|
                                                                            "p3_field::field::Field",
                                                                            F,
                                                                            [],
                                                                            [],
                                                                            "is_one",
                                                                            [],
                                                                            []
                                                                          |),
                                                                          [
                                                                            M.borrow (|
                                                                              Pointer.Kind.Ref,
                                                                              M.deref (|
                                                                                M.read (| x |)
                                                                              |)
                                                                            |)
                                                                          ]
                                                                        |)))
                                                                    |)
                                                                  |)
                                                                |)) in
                                                            let _ :=
                                                              is_constant_or_break_match (|
                                                                M.read (| γ |),
                                                                Value.Bool true
                                                              |) in
                                                            M.alloc (|
                                                              M.never_to_any (|
                                                                M.call_closure (|
                                                                  Ty.path "never",
                                                                  M.get_function (|
                                                                    "core::panicking::panic",
                                                                    [],
                                                                    []
                                                                  |),
                                                                  [
                                                                    mk_str (|
                                                                      "assertion failed: x.is_zero() || x.is_one()"
                                                                    |)
                                                                  ]
                                                                |)
                                                              |)
                                                            |)));
                                                        fun γ =>
                                                          ltac:(M.monadic
                                                            (M.alloc (| Value.Tuple [] |)))
                                                      ]
                                                    |) in
                                                  M.alloc (| Value.Tuple [] |)));
                                              fun γ =>
                                                ltac:(M.monadic (M.alloc (| Value.Tuple [] |)))
                                            ]
                                          |) in
                                        M.alloc (|
                                          M.call_closure (|
                                            F,
                                            M.get_trait_method (|
                                              "p3_field::field::PrimeCharacteristicRing",
                                              F,
                                              [],
                                              [],
                                              "xor",
                                              [],
                                              []
                                            |),
                                            [
                                              M.borrow (| Pointer.Kind.Ref, acc |);
                                              M.borrow (|
                                                Pointer.Kind.Ref,
                                                M.deref (| M.read (| x |) |)
                                              |)
                                            ]
                                          |)
                                        |)
                                      |)))
                                ]
                              |)))
                        ]
                      |)))
                  | _ => M.impossible "wrong number of arguments"
                  end))
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_checked_xor :
    M.IsFunction.C "p3_air::utils::checked_xor" checked_xor.
  Admitted.
  Global Typeclasses Opaque checked_xor.
  
  (*
  pub fn checked_andn<F: Field>(x: F, y: F) -> F {
      debug_assert!(x.is_zero() || x.is_one());
      debug_assert!(y.is_zero() || y.is_one());
      x.andn(&y)
  }
  *)
  Definition checked_andn (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ F ], [ x; y ] =>
      ltac:(M.monadic
        (let x := M.alloc (| x |) in
        let y := M.alloc (| y |) in
        M.read (|
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.match_operator (|
              Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
              M.alloc (| Value.Tuple [] |),
              [
                fun γ =>
                  ltac:(M.monadic
                    (let γ := M.use (M.alloc (| Value.Bool true |)) in
                    let _ := is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                    let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                      M.match_operator (|
                        Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
                        M.alloc (| Value.Tuple [] |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let γ :=
                                M.use
                                  (M.alloc (|
                                    UnOp.not (|
                                      LogicalOp.or (|
                                        M.call_closure (|
                                          Ty.path "bool",
                                          M.get_trait_method (|
                                            "p3_field::field::Field",
                                            F,
                                            [],
                                            [],
                                            "is_zero",
                                            [],
                                            []
                                          |),
                                          [ M.borrow (| Pointer.Kind.Ref, x |) ]
                                        |),
                                        ltac:(M.monadic
                                          (M.call_closure (|
                                            Ty.path "bool",
                                            M.get_trait_method (|
                                              "p3_field::field::Field",
                                              F,
                                              [],
                                              [],
                                              "is_one",
                                              [],
                                              []
                                            |),
                                            [ M.borrow (| Pointer.Kind.Ref, x |) ]
                                          |)))
                                      |)
                                    |)
                                  |)) in
                              let _ :=
                                is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                              M.alloc (|
                                M.never_to_any (|
                                  M.call_closure (|
                                    Ty.path "never",
                                    M.get_function (| "core::panicking::panic", [], [] |),
                                    [ mk_str (| "assertion failed: x.is_zero() || x.is_one()" |) ]
                                  |)
                                |)
                              |)));
                          fun γ => ltac:(M.monadic (M.alloc (| Value.Tuple [] |)))
                        ]
                      |) in
                    M.alloc (| Value.Tuple [] |)));
                fun γ => ltac:(M.monadic (M.alloc (| Value.Tuple [] |)))
              ]
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.match_operator (|
              Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
              M.alloc (| Value.Tuple [] |),
              [
                fun γ =>
                  ltac:(M.monadic
                    (let γ := M.use (M.alloc (| Value.Bool true |)) in
                    let _ := is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                    let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                      M.match_operator (|
                        Ty.apply (Ty.path "*") [] [ Ty.tuple [] ],
                        M.alloc (| Value.Tuple [] |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let γ :=
                                M.use
                                  (M.alloc (|
                                    UnOp.not (|
                                      LogicalOp.or (|
                                        M.call_closure (|
                                          Ty.path "bool",
                                          M.get_trait_method (|
                                            "p3_field::field::Field",
                                            F,
                                            [],
                                            [],
                                            "is_zero",
                                            [],
                                            []
                                          |),
                                          [ M.borrow (| Pointer.Kind.Ref, y |) ]
                                        |),
                                        ltac:(M.monadic
                                          (M.call_closure (|
                                            Ty.path "bool",
                                            M.get_trait_method (|
                                              "p3_field::field::Field",
                                              F,
                                              [],
                                              [],
                                              "is_one",
                                              [],
                                              []
                                            |),
                                            [ M.borrow (| Pointer.Kind.Ref, y |) ]
                                          |)))
                                      |)
                                    |)
                                  |)) in
                              let _ :=
                                is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                              M.alloc (|
                                M.never_to_any (|
                                  M.call_closure (|
                                    Ty.path "never",
                                    M.get_function (| "core::panicking::panic", [], [] |),
                                    [ mk_str (| "assertion failed: y.is_zero() || y.is_one()" |) ]
                                  |)
                                |)
                              |)));
                          fun γ => ltac:(M.monadic (M.alloc (| Value.Tuple [] |)))
                        ]
                      |) in
                    M.alloc (| Value.Tuple [] |)));
                fun γ => ltac:(M.monadic (M.alloc (| Value.Tuple [] |)))
              ]
            |) in
          M.alloc (|
            M.call_closure (|
              F,
              M.get_trait_method (|
                "p3_field::field::PrimeCharacteristicRing",
                F,
                [],
                [],
                "andn",
                [],
                []
              |),
              [
                M.borrow (| Pointer.Kind.Ref, x |);
                M.borrow (| Pointer.Kind.Ref, M.deref (| M.borrow (| Pointer.Kind.Ref, y |) |) |)
              ]
            |)
          |)
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_checked_andn :
    M.IsFunction.C "p3_air::utils::checked_andn" checked_andn.
  Admitted.
  Global Typeclasses Opaque checked_andn.
  
  (*
  pub fn u32_to_bits_le<R: PrimeCharacteristicRing>(val: u32) -> [R; 32] {
      array::from_fn(|i| R::from_bool(val & (1 << i) != 0))
  }
  *)
  Definition u32_to_bits_le (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ R ], [ val ] =>
      ltac:(M.monadic
        (let val := M.alloc (| val |) in
        M.call_closure (|
          Ty.apply (Ty.path "array") [ Value.Integer IntegerKind.Usize 32 ] [ R ],
          M.get_function (|
            "core::array::from_fn",
            [ Value.Integer IntegerKind.Usize 32 ],
            [ R; Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ]
          |),
          [
            M.closure
              (fun γ =>
                ltac:(M.monadic
                  match γ with
                  | [ α0 ] =>
                    ltac:(M.monadic
                      (M.match_operator (|
                        Ty.apply
                          (Ty.path "*")
                          []
                          [ Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ],
                        M.alloc (| α0 |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let i := M.copy (| γ |) in
                              M.call_closure (|
                                R,
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  R,
                                  [],
                                  [],
                                  "from_bool",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.path "bool",
                                    BinOp.ne,
                                    [
                                      M.call_closure (|
                                        Ty.path "u32",
                                        BinOp.Wrap.bit_and,
                                        [
                                          M.read (| val |);
                                          M.call_closure (|
                                            Ty.path "u32",
                                            BinOp.Wrap.shl,
                                            [ Value.Integer IntegerKind.U32 1; M.read (| i |) ]
                                          |)
                                        ]
                                      |);
                                      Value.Integer IntegerKind.U32 0
                                    ]
                                  |)
                                ]
                              |)))
                        ]
                      |)))
                  | _ => M.impossible "wrong number of arguments"
                  end))
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_u32_to_bits_le :
    M.IsFunction.C "p3_air::utils::u32_to_bits_le" u32_to_bits_le.
  Admitted.
  Global Typeclasses Opaque u32_to_bits_le.
  
  (*
  pub fn u64_to_bits_le<R: PrimeCharacteristicRing>(val: u64) -> [R; 64] {
      array::from_fn(|i| R::from_bool(val & (1 << i) != 0))
  }
  *)
  Definition u64_to_bits_le (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ R ], [ val ] =>
      ltac:(M.monadic
        (let val := M.alloc (| val |) in
        M.call_closure (|
          Ty.apply (Ty.path "array") [ Value.Integer IntegerKind.Usize 64 ] [ R ],
          M.get_function (|
            "core::array::from_fn",
            [ Value.Integer IntegerKind.Usize 64 ],
            [ R; Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ]
          |),
          [
            M.closure
              (fun γ =>
                ltac:(M.monadic
                  match γ with
                  | [ α0 ] =>
                    ltac:(M.monadic
                      (M.match_operator (|
                        Ty.apply
                          (Ty.path "*")
                          []
                          [ Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ],
                        M.alloc (| α0 |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let i := M.copy (| γ |) in
                              M.call_closure (|
                                R,
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  R,
                                  [],
                                  [],
                                  "from_bool",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.path "bool",
                                    BinOp.ne,
                                    [
                                      M.call_closure (|
                                        Ty.path "u64",
                                        BinOp.Wrap.bit_and,
                                        [
                                          M.read (| val |);
                                          M.call_closure (|
                                            Ty.path "u64",
                                            BinOp.Wrap.shl,
                                            [ Value.Integer IntegerKind.U64 1; M.read (| i |) ]
                                          |)
                                        ]
                                      |);
                                      Value.Integer IntegerKind.U64 0
                                    ]
                                  |)
                                ]
                              |)))
                        ]
                      |)))
                  | _ => M.impossible "wrong number of arguments"
                  end))
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_u64_to_bits_le :
    M.IsFunction.C "p3_air::utils::u64_to_bits_le" u64_to_bits_le.
  Admitted.
  Global Typeclasses Opaque u64_to_bits_le.
  
  (*
  pub fn u64_to_16_bit_limbs<R: PrimeCharacteristicRing>(val: u64) -> [R; 4] {
      array::from_fn(|i| R::from_u16((val >> (16 * i)) as u16))
  }
  *)
  Definition u64_to_16_bit_limbs (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ R ], [ val ] =>
      ltac:(M.monadic
        (let val := M.alloc (| val |) in
        M.call_closure (|
          Ty.apply (Ty.path "array") [ Value.Integer IntegerKind.Usize 4 ] [ R ],
          M.get_function (|
            "core::array::from_fn",
            [ Value.Integer IntegerKind.Usize 4 ],
            [ R; Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ]
          |),
          [
            M.closure
              (fun γ =>
                ltac:(M.monadic
                  match γ with
                  | [ α0 ] =>
                    ltac:(M.monadic
                      (M.match_operator (|
                        Ty.apply
                          (Ty.path "*")
                          []
                          [ Ty.function [ Ty.tuple [ Ty.path "usize" ] ] R ],
                        M.alloc (| α0 |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let i := M.copy (| γ |) in
                              M.call_closure (|
                                R,
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  R,
                                  [],
                                  [],
                                  "from_u16",
                                  [],
                                  []
                                |),
                                [
                                  M.cast
                                    (Ty.path "u16")
                                    (M.call_closure (|
                                      Ty.path "u64",
                                      BinOp.Wrap.shr,
                                      [
                                        M.read (| val |);
                                        M.call_closure (|
                                          Ty.path "usize",
                                          BinOp.Wrap.mul,
                                          [ Value.Integer IntegerKind.Usize 16; M.read (| i |) ]
                                        |)
                                      ]
                                    |))
                                ]
                              |)))
                        ]
                      |)))
                  | _ => M.impossible "wrong number of arguments"
                  end))
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_u64_to_16_bit_limbs :
    M.IsFunction.C "p3_air::utils::u64_to_16_bit_limbs" u64_to_16_bit_limbs.
  Admitted.
  Global Typeclasses Opaque u64_to_16_bit_limbs.
  
  (*
  pub fn add3<AB: AirBuilder>(
      builder: &mut AB,
      a: &[AB::Var; 2],
      b: &[AB::Var; 2],
      c: &[AB::Expr; 2],
      d: &[AB::Expr; 2],
  ) {
      // Define:
      //  acc    = a - b - c - d (mod P)
      //  acc_16 = a[0] - b[0] - c[0] - d[0] (mod P)
      //
      // We perform 2 checks:
      //
      // (1) acc*(acc + 2^32)*(acc + 2*2^32) = 0.
      // (2) acc_16*(acc_16 + 2^16)*(acc_16 + 2*2^16) = 0.
      //
      // We give a short proof for why this lets us conclude that a = b + c + d mod 2^32:
      //
      // As all 16 bit limbs have been range checked, we know that a, b, c, d lie in [0, 2^32) and hence
      // a = b + c + d mod 2^32 if and only if, over the integers, a - b - c - d = 0, -2^32 or -2*2^32.
      //
      // Equation (1) verifies that a - b - c - d mod P = 0, -2^32 or -2*2^32.
      //
      // Field overflow cannot occur when computing acc_16 as our characteristic is larger than 3*2^16.
      // Hence, equation (2) verifies that, over the integers, a[0] - b[0] - c[0] - d[0] = 0, -2^16 or -2*2^16.
      // Either way we can immediately conclude that a - b - c - d = 0 mod 2^16.
      //
      // Now we can use the chinese remainder theorem to combine these results to conclude that
      // a - b - c - d mod 2^16P = 0, -2^32 or -2*2^32.
      //
      // No overflow can occur mod 2^16 P as 2^16 P > 3*2^32 and a, b, c, d < 2^32. Hence we conclude that
      // over the integers a - b - c - d = 0, -2^32 or -2*2^32 which implies a = b + c + d mod 2^32.
  
      // By assumption P > 3*2^16 so 1 << 16 will be less than P. We use the checked version just to be safe.
      // The compiler should optimize it away.
      let two_16 =
          <AB::Expr as PrimeCharacteristicRing>::PrimeSubfield::from_canonical_checked(1 << 16)
              .unwrap();
      let two_32 = two_16.square();
  
      let acc_16 = a[0] - b[0] - c[0].clone() - d[0].clone();
      let acc_32 = a[1] - b[1] - c[1].clone() - d[1].clone();
      let acc = acc_16.clone() + acc_32.mul_2exp_u64(16);
  
      builder.assert_zeros([
          acc.clone()
              * (acc.clone() + AB::Expr::from_prime_subfield(two_32))
              * (acc + AB::Expr::from_prime_subfield(two_32.double())),
          acc_16.clone()
              * (acc_16.clone() + AB::Expr::from_prime_subfield(two_16))
              * (acc_16 + AB::Expr::from_prime_subfield(two_16.double())),
      ]);
  }
  *)
  Definition add3 (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ AB ], [ builder; a; b; c; d ] =>
      ltac:(M.monadic
        (let builder := M.alloc (| builder |) in
        let a := M.alloc (| a |) in
        let b := M.alloc (| b |) in
        let c := M.alloc (| c |) in
        let d := M.alloc (| d |) in
        M.read (|
          let~ two_16 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield"
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait
                  "p3_field::field::PrimeCharacteristicRing"
                  []
                  []
                  (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  "PrimeSubfield",
                M.get_associated_function (|
                  Ty.apply
                    (Ty.path "core::option::Option")
                    []
                    [
                      Ty.associated_in_trait
                        "p3_field::field::PrimeCharacteristicRing"
                        []
                        []
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                        "PrimeSubfield"
                    ],
                  "unwrap",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.apply
                      (Ty.path "core::option::Option")
                      []
                      [
                        Ty.associated_in_trait
                          "p3_field::field::PrimeCharacteristicRing"
                          []
                          []
                          (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                          "PrimeSubfield"
                      ],
                    M.get_trait_method (|
                      "p3_field::integers::QuotientMap",
                      Ty.associated_in_trait
                        "p3_field::field::PrimeCharacteristicRing"
                        []
                        []
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                        "PrimeSubfield",
                      [],
                      [ Ty.path "i32" ],
                      "from_canonical_checked",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.path "i32",
                        BinOp.Wrap.shl,
                        [ Value.Integer IntegerKind.I32 1; Value.Integer IntegerKind.I32 16 ]
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ two_32 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield"
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait
                  "p3_field::field::PrimeCharacteristicRing"
                  []
                  []
                  (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  "PrimeSubfield",
                M.get_trait_method (|
                  "p3_field::field::PrimeCharacteristicRing",
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield",
                  [],
                  [],
                  "square",
                  [],
                  []
                |),
                [ M.borrow (| Pointer.Kind.Ref, two_16 |) ]
              |)
            |) in
          let~ acc_16 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Sub",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "sub",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::ops::arith::Sub",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                      "sub",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Sub",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                          "sub",
                          [],
                          []
                        |),
                        [
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| a |) |),
                              Value.Integer IntegerKind.Usize 0
                            |)
                          |);
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| b |) |),
                              Value.Integer IntegerKind.Usize 0
                            |)
                          |)
                        ]
                      |);
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::clone::Clone",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [],
                          "clone",
                          [],
                          []
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| c |) |),
                              Value.Integer IntegerKind.Usize 0
                            |)
                          |)
                        ]
                      |)
                    ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| d |) |),
                          Value.Integer IntegerKind.Usize 0
                        |)
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ acc_32 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Sub",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "sub",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::ops::arith::Sub",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                      "sub",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Sub",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                          "sub",
                          [],
                          []
                        |),
                        [
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| a |) |),
                              Value.Integer IntegerKind.Usize 1
                            |)
                          |);
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| b |) |),
                              Value.Integer IntegerKind.Usize 1
                            |)
                          |)
                        ]
                      |);
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::clone::Clone",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [],
                          "clone",
                          [],
                          []
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| c |) |),
                              Value.Integer IntegerKind.Usize 1
                            |)
                          |)
                        ]
                      |)
                    ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| d |) |),
                          Value.Integer IntegerKind.Usize 1
                        |)
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ acc :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Add",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "add",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [ M.borrow (| Pointer.Kind.Ref, acc_16 |) ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "p3_field::field::PrimeCharacteristicRing",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "mul_2exp_u64",
                      [],
                      []
                    |),
                    [ M.borrow (| Pointer.Kind.Ref, acc_32 |); Value.Integer IntegerKind.U64 16 ]
                  |)
                ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "p3_air::air::AirBuilder",
                  AB,
                  [],
                  [],
                  "assert_zeros",
                  [ Value.Integer IntegerKind.Usize 2 ],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ]
                |),
                [
                  M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| builder |) |) |);
                  Value.Array
                    [
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Mul",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "mul",
                          [],
                          []
                        |),
                        [
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Mul",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "mul",
                              [],
                              []
                            |),
                            [
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "core::clone::Clone",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "clone",
                                  [],
                                  []
                                |),
                                [ M.borrow (| Pointer.Kind.Ref, acc |) ]
                              |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "core::ops::arith::Add",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr"
                                  ],
                                  "add",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr",
                                    M.get_trait_method (|
                                      "core::clone::Clone",
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      [],
                                      [],
                                      "clone",
                                      [],
                                      []
                                    |),
                                    [ M.borrow (| Pointer.Kind.Ref, acc |) ]
                                  |);
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr",
                                    M.get_trait_method (|
                                      "p3_field::field::PrimeCharacteristicRing",
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      [],
                                      [],
                                      "from_prime_subfield",
                                      [],
                                      []
                                    |),
                                    [ M.read (| two_32 |) ]
                                  |)
                                ]
                              |)
                            ]
                          |);
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Add",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "add",
                              [],
                              []
                            |),
                            [
                              M.read (| acc |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "from_prime_subfield",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_field::field::PrimeCharacteristicRing"
                                      []
                                      []
                                      (Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr")
                                      "PrimeSubfield",
                                    M.get_trait_method (|
                                      "p3_field::field::PrimeCharacteristicRing",
                                      Ty.associated_in_trait
                                        "p3_field::field::PrimeCharacteristicRing"
                                        []
                                        []
                                        (Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Expr")
                                        "PrimeSubfield",
                                      [],
                                      [],
                                      "double",
                                      [],
                                      []
                                    |),
                                    [ M.borrow (| Pointer.Kind.Ref, two_32 |) ]
                                  |)
                                ]
                              |)
                            ]
                          |)
                        ]
                      |);
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Mul",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "mul",
                          [],
                          []
                        |),
                        [
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Mul",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "mul",
                              [],
                              []
                            |),
                            [
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "core::clone::Clone",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "clone",
                                  [],
                                  []
                                |),
                                [ M.borrow (| Pointer.Kind.Ref, acc_16 |) ]
                              |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "core::ops::arith::Add",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr"
                                  ],
                                  "add",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr",
                                    M.get_trait_method (|
                                      "core::clone::Clone",
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      [],
                                      [],
                                      "clone",
                                      [],
                                      []
                                    |),
                                    [ M.borrow (| Pointer.Kind.Ref, acc_16 |) ]
                                  |);
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr",
                                    M.get_trait_method (|
                                      "p3_field::field::PrimeCharacteristicRing",
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      [],
                                      [],
                                      "from_prime_subfield",
                                      [],
                                      []
                                    |),
                                    [ M.read (| two_16 |) ]
                                  |)
                                ]
                              |)
                            ]
                          |);
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Add",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "add",
                              [],
                              []
                            |),
                            [
                              M.read (| acc_16 |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "from_prime_subfield",
                                  [],
                                  []
                                |),
                                [
                                  M.call_closure (|
                                    Ty.associated_in_trait
                                      "p3_field::field::PrimeCharacteristicRing"
                                      []
                                      []
                                      (Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr")
                                      "PrimeSubfield",
                                    M.get_trait_method (|
                                      "p3_field::field::PrimeCharacteristicRing",
                                      Ty.associated_in_trait
                                        "p3_field::field::PrimeCharacteristicRing"
                                        []
                                        []
                                        (Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Expr")
                                        "PrimeSubfield",
                                      [],
                                      [],
                                      "double",
                                      [],
                                      []
                                    |),
                                    [ M.borrow (| Pointer.Kind.Ref, two_16 |) ]
                                  |)
                                ]
                              |)
                            ]
                          |)
                        ]
                      |)
                    ]
                ]
              |)
            |) in
          M.alloc (| Value.Tuple [] |)
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_add3 : M.IsFunction.C "p3_air::utils::add3" add3.
  Admitted.
  Global Typeclasses Opaque add3.
  
  (*
  pub fn add2<AB: AirBuilder>(
      builder: &mut AB,
      a: &[AB::Var; 2],
      b: &[AB::Var; 2],
      c: &[AB::Expr; 2],
  ) {
      // Define:
      //  acc    = a - b - c (mod P)
      //  acc_16 = a[0] - b[0] - c[0] (mod P)
      //
      // We perform 2 checks:
      //
      // (1) acc*(acc + 2^32) = 0.
      // (2) acc_16*(acc_16 + 2^16) = 0.
      //
      // We give a short proof for why this lets us conclude that a = b + c mod 2^32:
      //
      // As all 16 bit limbs have been range checked, we know that a, b, c lie in [0, 2^32) and hence
      // a = b + c mod 2^32 if and only if, over the integers, a - b - c = 0 or -2^32.
      //
      // Equation (1) verifies that either a - b - c = 0 mod P or a - b - c = -2^32 mod P.
      //
      // Field overflow cannot occur when computing acc_16 as our characteristic is larger than 2^17.
      // Hence, equation (2) verifies that, over the integers, a[0] - b[0] - c[0] = 0 or -2^16.
      // Either way we can immediately conclude that a - b - c = 0 mod 2^16.
      //
      // Now we can use the chinese remainder theorem to combine these results to conclude that
      // either a - b - c = 0 mod 2^16 P or a - b - c = -2^32 mod 2^16 P.
      //
      // No overflow can occur mod 2^16 P as 2^16 P > 2^33 and a, b, c < 2^32. Hence we conclude that
      // over the integers a - b - c = 0 or a - b - c = -2^32 which is equivalent to a = b + c mod 2^32.
  
      // By assumption P > 2^17 so 1 << 16 will be less than P. We use the checked version just to be safe.
      // The compiler should optimize it away.
      let two_16 =
          <AB::Expr as PrimeCharacteristicRing>::PrimeSubfield::from_canonical_checked(1 << 16)
              .unwrap();
      let two_32 = two_16.square();
  
      let acc_16 = a[0] - b[0] - c[0].clone();
      let acc_32 = a[1] - b[1] - c[1].clone();
      let acc = acc_16.clone() + acc_32.mul_2exp_u64(16);
  
      builder.assert_zeros([
          acc.clone() * (acc + AB::Expr::from_prime_subfield(two_32)),
          acc_16.clone() * (acc_16 + AB::Expr::from_prime_subfield(two_16)),
      ]);
  }
  *)
  Definition add2 (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ AB ], [ builder; a; b; c ] =>
      ltac:(M.monadic
        (let builder := M.alloc (| builder |) in
        let a := M.alloc (| a |) in
        let b := M.alloc (| b |) in
        let c := M.alloc (| c |) in
        M.read (|
          let~ two_16 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield"
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait
                  "p3_field::field::PrimeCharacteristicRing"
                  []
                  []
                  (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  "PrimeSubfield",
                M.get_associated_function (|
                  Ty.apply
                    (Ty.path "core::option::Option")
                    []
                    [
                      Ty.associated_in_trait
                        "p3_field::field::PrimeCharacteristicRing"
                        []
                        []
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                        "PrimeSubfield"
                    ],
                  "unwrap",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.apply
                      (Ty.path "core::option::Option")
                      []
                      [
                        Ty.associated_in_trait
                          "p3_field::field::PrimeCharacteristicRing"
                          []
                          []
                          (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                          "PrimeSubfield"
                      ],
                    M.get_trait_method (|
                      "p3_field::integers::QuotientMap",
                      Ty.associated_in_trait
                        "p3_field::field::PrimeCharacteristicRing"
                        []
                        []
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                        "PrimeSubfield",
                      [],
                      [ Ty.path "i32" ],
                      "from_canonical_checked",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.path "i32",
                        BinOp.Wrap.shl,
                        [ Value.Integer IntegerKind.I32 1; Value.Integer IntegerKind.I32 16 ]
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ two_32 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield"
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait
                  "p3_field::field::PrimeCharacteristicRing"
                  []
                  []
                  (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  "PrimeSubfield",
                M.get_trait_method (|
                  "p3_field::field::PrimeCharacteristicRing",
                  Ty.associated_in_trait
                    "p3_field::field::PrimeCharacteristicRing"
                    []
                    []
                    (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    "PrimeSubfield",
                  [],
                  [],
                  "square",
                  [],
                  []
                |),
                [ M.borrow (| Pointer.Kind.Ref, two_16 |) ]
              |)
            |) in
          let~ acc_16 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Sub",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "sub",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::ops::arith::Sub",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                      [],
                      [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                      "sub",
                      [],
                      []
                    |),
                    [
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| a |) |),
                          Value.Integer IntegerKind.Usize 0
                        |)
                      |);
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| b |) |),
                          Value.Integer IntegerKind.Usize 0
                        |)
                      |)
                    ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| c |) |),
                          Value.Integer IntegerKind.Usize 0
                        |)
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ acc_32 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Sub",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "sub",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::ops::arith::Sub",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                      [],
                      [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                      "sub",
                      [],
                      []
                    |),
                    [
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| a |) |),
                          Value.Integer IntegerKind.Usize 1
                        |)
                      |);
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| b |) |),
                          Value.Integer IntegerKind.Usize 1
                        |)
                      |)
                    ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| c |) |),
                          Value.Integer IntegerKind.Usize 1
                        |)
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ acc :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_trait_method (|
                  "core::ops::arith::Add",
                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                  [],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                  "add",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "core::clone::Clone",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "clone",
                      [],
                      []
                    |),
                    [ M.borrow (| Pointer.Kind.Ref, acc_16 |) ]
                  |);
                  M.call_closure (|
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                    M.get_trait_method (|
                      "p3_field::field::PrimeCharacteristicRing",
                      Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                      [],
                      [],
                      "mul_2exp_u64",
                      [],
                      []
                    |),
                    [ M.borrow (| Pointer.Kind.Ref, acc_32 |); Value.Integer IntegerKind.U64 16 ]
                  |)
                ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "p3_air::air::AirBuilder",
                  AB,
                  [],
                  [],
                  "assert_zeros",
                  [ Value.Integer IntegerKind.Usize 2 ],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ]
                |),
                [
                  M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| builder |) |) |);
                  Value.Array
                    [
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Mul",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "mul",
                          [],
                          []
                        |),
                        [
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::clone::Clone",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [],
                              "clone",
                              [],
                              []
                            |),
                            [ M.borrow (| Pointer.Kind.Ref, acc |) ]
                          |);
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Add",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "add",
                              [],
                              []
                            |),
                            [
                              M.read (| acc |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "from_prime_subfield",
                                  [],
                                  []
                                |),
                                [ M.read (| two_32 |) ]
                              |)
                            ]
                          |)
                        ]
                      |);
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Mul",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "mul",
                          [],
                          []
                        |),
                        [
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::clone::Clone",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [],
                              "clone",
                              [],
                              []
                            |),
                            [ M.borrow (| Pointer.Kind.Ref, acc_16 |) ]
                          |);
                          M.call_closure (|
                            Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                            M.get_trait_method (|
                              "core::ops::arith::Add",
                              Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                              [],
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                              "add",
                              [],
                              []
                            |),
                            [
                              M.read (| acc_16 |);
                              M.call_closure (|
                                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                M.get_trait_method (|
                                  "p3_field::field::PrimeCharacteristicRing",
                                  Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                                  [],
                                  [],
                                  "from_prime_subfield",
                                  [],
                                  []
                                |),
                                [ M.read (| two_16 |) ]
                              |)
                            ]
                          |)
                        ]
                      |)
                    ]
                ]
              |)
            |) in
          M.alloc (| Value.Tuple [] |)
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_add2 : M.IsFunction.C "p3_air::utils::add2" add2.
  Admitted.
  Global Typeclasses Opaque add2.
  
  (*
  pub fn xor_32_shift<AB: AirBuilder>(
      builder: &mut AB,
      a: &[AB::Var; 2],
      b: &[AB::Var; 32],
      c: &[AB::Var; 32],
      shift: usize,
  ) {
      // First we range check all elements of c.
      builder.assert_bools( *c);
  
      // Next we compute (b ^ (c << shift)) and pack the result into two 16-bit integers.
      let xor_shift_c_0_16 = b[..16]
          .iter()
          .enumerate()
          .map(|(i, elem)| ( *elem).into().xor(&c[(32 + i - shift) % 32].into()));
      let sum_0_16: AB::Expr = pack_bits_le(xor_shift_c_0_16);
  
      let xor_shift_c_16_32 = b[16..]
          .iter()
          .enumerate()
          .map(|(i, elem)| ( *elem).into().xor(&c[(32 + (i + 16) - shift) % 32].into()));
      let sum_16_32: AB::Expr = pack_bits_le(xor_shift_c_16_32);
  
      // As both b and c have been range checked to be boolean, all the (b ^ (c << shift))
      // are also boolean and so this final check additionally has the effect of range checking a[0], a[1].
      builder.assert_zeros([a[0] - sum_0_16, a[1] - sum_16_32]);
  }
  *)
  Definition xor_32_shift (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [ AB ], [ builder; a; b; c; shift ] =>
      ltac:(M.monadic
        (let builder := M.alloc (| builder |) in
        let a := M.alloc (| a |) in
        let b := M.alloc (| b |) in
        let c := M.alloc (| c |) in
        let shift := M.alloc (| shift |) in
        M.read (|
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "p3_air::air::AirBuilder",
                  AB,
                  [],
                  [],
                  "assert_bools",
                  [ Value.Integer IntegerKind.Usize 32 ],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                |),
                [
                  M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| builder |) |) |);
                  M.read (| M.deref (| M.read (| c |) |) |)
                ]
              |)
            |) in
          let~ xor_shift_c_0_16 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.apply
                    (Ty.path "core::iter::adapters::map::Map")
                    []
                    [
                      Ty.apply
                        (Ty.path "core::iter::adapters::enumerate::Enumerate")
                        []
                        [
                          Ty.apply
                            (Ty.path "core::slice::iter::Iter")
                            []
                            [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                        ];
                      Ty.function
                        [
                          Ty.tuple
                            [
                              Ty.tuple
                                [
                                  Ty.path "usize";
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Var"
                                    ]
                                ]
                            ]
                        ]
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    ]
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.apply
                  (Ty.path "core::iter::adapters::map::Map")
                  []
                  [
                    Ty.apply
                      (Ty.path "core::iter::adapters::enumerate::Enumerate")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                      ];
                    Ty.function
                      [
                        Ty.tuple
                          [
                            Ty.tuple
                              [
                                Ty.path "usize";
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var"
                                  ]
                              ]
                          ]
                      ]
                      (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  ],
                M.get_trait_method (|
                  "core::iter::traits::iterator::Iterator",
                  Ty.apply
                    (Ty.path "core::iter::adapters::enumerate::Enumerate")
                    []
                    [
                      Ty.apply
                        (Ty.path "core::slice::iter::Iter")
                        []
                        [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                    ],
                  [],
                  [],
                  "map",
                  [],
                  [
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.function
                      [
                        Ty.tuple
                          [
                            Ty.tuple
                              [
                                Ty.path "usize";
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var"
                                  ]
                              ]
                          ]
                      ]
                      (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  ]
                |),
                [
                  M.call_closure (|
                    Ty.apply
                      (Ty.path "core::iter::adapters::enumerate::Enumerate")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                      ],
                    M.get_trait_method (|
                      "core::iter::traits::iterator::Iterator",
                      Ty.apply
                        (Ty.path "core::slice::iter::Iter")
                        []
                        [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                      [],
                      [],
                      "enumerate",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                        M.get_associated_function (|
                          Ty.apply
                            (Ty.path "slice")
                            []
                            [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                          "iter",
                          [],
                          []
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.deref (|
                              M.call_closure (|
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [
                                    Ty.apply
                                      (Ty.path "slice")
                                      []
                                      [
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Var"
                                      ]
                                  ],
                                M.get_trait_method (|
                                  "core::ops::index::Index",
                                  Ty.apply
                                    (Ty.path "array")
                                    [ Value.Integer IntegerKind.Usize 32 ]
                                    [
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Var"
                                    ],
                                  [],
                                  [
                                    Ty.apply
                                      (Ty.path "core::ops::range::RangeTo")
                                      []
                                      [ Ty.path "usize" ]
                                  ],
                                  "index",
                                  [],
                                  []
                                |),
                                [
                                  M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| b |) |) |);
                                  Value.StructRecord
                                    "core::ops::range::RangeTo"
                                    []
                                    [ Ty.path "usize" ]
                                    [ ("end_", Value.Integer IntegerKind.Usize 16) ]
                                ]
                              |)
                            |)
                          |)
                        ]
                      |)
                    ]
                  |);
                  M.closure
                    (fun γ =>
                      ltac:(M.monadic
                        match γ with
                        | [ α0 ] =>
                          ltac:(M.monadic
                            (M.match_operator (|
                              Ty.apply
                                (Ty.path "*")
                                []
                                [
                                  Ty.function
                                    [
                                      Ty.tuple
                                        [
                                          Ty.tuple
                                            [
                                              Ty.path "usize";
                                              Ty.apply
                                                (Ty.path "&")
                                                []
                                                [
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Var"
                                                ]
                                            ]
                                        ]
                                    ]
                                    (Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr")
                                ],
                              M.alloc (| α0 |),
                              [
                                fun γ =>
                                  ltac:(M.monadic
                                    (let γ0_0 := M.SubPointer.get_tuple_field (| γ, 0 |) in
                                    let γ0_1 := M.SubPointer.get_tuple_field (| γ, 1 |) in
                                    let i := M.copy (| γ0_0 |) in
                                    let elem := M.copy (| γ0_1 |) in
                                    M.call_closure (|
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      M.get_trait_method (|
                                        "p3_field::field::PrimeCharacteristicRing",
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Expr",
                                        [],
                                        [],
                                        "xor",
                                        [],
                                        []
                                      |),
                                      [
                                        M.borrow (|
                                          Pointer.Kind.Ref,
                                          M.alloc (|
                                            M.call_closure (|
                                              Ty.associated_in_trait
                                                "p3_air::air::AirBuilder"
                                                []
                                                []
                                                AB
                                                "Expr",
                                              M.get_trait_method (|
                                                "core::convert::Into",
                                                Ty.associated_in_trait
                                                  "p3_air::air::AirBuilder"
                                                  []
                                                  []
                                                  AB
                                                  "Var",
                                                [],
                                                [
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Expr"
                                                ],
                                                "into",
                                                [],
                                                []
                                              |),
                                              [ M.read (| M.deref (| M.read (| elem |) |) |) ]
                                            |)
                                          |)
                                        |);
                                        M.borrow (|
                                          Pointer.Kind.Ref,
                                          M.deref (|
                                            M.borrow (|
                                              Pointer.Kind.Ref,
                                              M.alloc (|
                                                M.call_closure (|
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Expr",
                                                  M.get_trait_method (|
                                                    "core::convert::Into",
                                                    Ty.associated_in_trait
                                                      "p3_air::air::AirBuilder"
                                                      []
                                                      []
                                                      AB
                                                      "Var",
                                                    [],
                                                    [
                                                      Ty.associated_in_trait
                                                        "p3_air::air::AirBuilder"
                                                        []
                                                        []
                                                        AB
                                                        "Expr"
                                                    ],
                                                    "into",
                                                    [],
                                                    []
                                                  |),
                                                  [
                                                    M.read (|
                                                      M.SubPointer.get_array_field (|
                                                        M.deref (| M.read (| c |) |),
                                                        M.call_closure (|
                                                          Ty.path "usize",
                                                          BinOp.Wrap.rem,
                                                          [
                                                            M.call_closure (|
                                                              Ty.path "usize",
                                                              BinOp.Wrap.sub,
                                                              [
                                                                M.call_closure (|
                                                                  Ty.path "usize",
                                                                  BinOp.Wrap.add,
                                                                  [
                                                                    Value.Integer
                                                                      IntegerKind.Usize
                                                                      32;
                                                                    M.read (| i |)
                                                                  ]
                                                                |);
                                                                M.read (| shift |)
                                                              ]
                                                            |);
                                                            Value.Integer IntegerKind.Usize 32
                                                          ]
                                                        |)
                                                      |)
                                                    |)
                                                  ]
                                                |)
                                              |)
                                            |)
                                          |)
                                        |)
                                      ]
                                    |)))
                              ]
                            |)))
                        | _ => M.impossible "wrong number of arguments"
                        end))
                ]
              |)
            |) in
          let~ sum_0_16 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_function (|
                  "p3_air::utils::pack_bits_le",
                  [],
                  [
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.apply
                      (Ty.path "core::iter::adapters::map::Map")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::iter::adapters::enumerate::Enumerate")
                          []
                          [
                            Ty.apply
                              (Ty.path "core::slice::iter::Iter")
                              []
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                          ];
                        Ty.function
                          [
                            Ty.tuple
                              [
                                Ty.tuple
                                  [
                                    Ty.path "usize";
                                    Ty.apply
                                      (Ty.path "&")
                                      []
                                      [
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Var"
                                      ]
                                  ]
                              ]
                          ]
                          (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                      ]
                  ]
                |),
                [ M.read (| xor_shift_c_0_16 |) ]
              |)
            |) in
          let~ xor_shift_c_16_32 :
              Ty.apply
                (Ty.path "*")
                []
                [
                  Ty.apply
                    (Ty.path "core::iter::adapters::map::Map")
                    []
                    [
                      Ty.apply
                        (Ty.path "core::iter::adapters::enumerate::Enumerate")
                        []
                        [
                          Ty.apply
                            (Ty.path "core::slice::iter::Iter")
                            []
                            [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                        ];
                      Ty.function
                        [
                          Ty.tuple
                            [
                              Ty.tuple
                                [
                                  Ty.path "usize";
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Var"
                                    ]
                                ]
                            ]
                        ]
                        (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                    ]
                ] :=
            M.alloc (|
              M.call_closure (|
                Ty.apply
                  (Ty.path "core::iter::adapters::map::Map")
                  []
                  [
                    Ty.apply
                      (Ty.path "core::iter::adapters::enumerate::Enumerate")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                      ];
                    Ty.function
                      [
                        Ty.tuple
                          [
                            Ty.tuple
                              [
                                Ty.path "usize";
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var"
                                  ]
                              ]
                          ]
                      ]
                      (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  ],
                M.get_trait_method (|
                  "core::iter::traits::iterator::Iterator",
                  Ty.apply
                    (Ty.path "core::iter::adapters::enumerate::Enumerate")
                    []
                    [
                      Ty.apply
                        (Ty.path "core::slice::iter::Iter")
                        []
                        [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                    ],
                  [],
                  [],
                  "map",
                  [],
                  [
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.function
                      [
                        Ty.tuple
                          [
                            Ty.tuple
                              [
                                Ty.path "usize";
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var"
                                  ]
                              ]
                          ]
                      ]
                      (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                  ]
                |),
                [
                  M.call_closure (|
                    Ty.apply
                      (Ty.path "core::iter::adapters::enumerate::Enumerate")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                      ],
                    M.get_trait_method (|
                      "core::iter::traits::iterator::Iterator",
                      Ty.apply
                        (Ty.path "core::slice::iter::Iter")
                        []
                        [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                      [],
                      [],
                      "enumerate",
                      [],
                      []
                    |),
                    [
                      M.call_closure (|
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                        M.get_associated_function (|
                          Ty.apply
                            (Ty.path "slice")
                            []
                            [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ],
                          "iter",
                          [],
                          []
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.deref (|
                              M.call_closure (|
                                Ty.apply
                                  (Ty.path "&")
                                  []
                                  [
                                    Ty.apply
                                      (Ty.path "slice")
                                      []
                                      [
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Var"
                                      ]
                                  ],
                                M.get_trait_method (|
                                  "core::ops::index::Index",
                                  Ty.apply
                                    (Ty.path "array")
                                    [ Value.Integer IntegerKind.Usize 32 ]
                                    [
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Var"
                                    ],
                                  [],
                                  [
                                    Ty.apply
                                      (Ty.path "core::ops::range::RangeFrom")
                                      []
                                      [ Ty.path "usize" ]
                                  ],
                                  "index",
                                  [],
                                  []
                                |),
                                [
                                  M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| b |) |) |);
                                  Value.StructRecord
                                    "core::ops::range::RangeFrom"
                                    []
                                    [ Ty.path "usize" ]
                                    [ ("start", Value.Integer IntegerKind.Usize 16) ]
                                ]
                              |)
                            |)
                          |)
                        ]
                      |)
                    ]
                  |);
                  M.closure
                    (fun γ =>
                      ltac:(M.monadic
                        match γ with
                        | [ α0 ] =>
                          ltac:(M.monadic
                            (M.match_operator (|
                              Ty.apply
                                (Ty.path "*")
                                []
                                [
                                  Ty.function
                                    [
                                      Ty.tuple
                                        [
                                          Ty.tuple
                                            [
                                              Ty.path "usize";
                                              Ty.apply
                                                (Ty.path "&")
                                                []
                                                [
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Var"
                                                ]
                                            ]
                                        ]
                                    ]
                                    (Ty.associated_in_trait
                                      "p3_air::air::AirBuilder"
                                      []
                                      []
                                      AB
                                      "Expr")
                                ],
                              M.alloc (| α0 |),
                              [
                                fun γ =>
                                  ltac:(M.monadic
                                    (let γ0_0 := M.SubPointer.get_tuple_field (| γ, 0 |) in
                                    let γ0_1 := M.SubPointer.get_tuple_field (| γ, 1 |) in
                                    let i := M.copy (| γ0_0 |) in
                                    let elem := M.copy (| γ0_1 |) in
                                    M.call_closure (|
                                      Ty.associated_in_trait
                                        "p3_air::air::AirBuilder"
                                        []
                                        []
                                        AB
                                        "Expr",
                                      M.get_trait_method (|
                                        "p3_field::field::PrimeCharacteristicRing",
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Expr",
                                        [],
                                        [],
                                        "xor",
                                        [],
                                        []
                                      |),
                                      [
                                        M.borrow (|
                                          Pointer.Kind.Ref,
                                          M.alloc (|
                                            M.call_closure (|
                                              Ty.associated_in_trait
                                                "p3_air::air::AirBuilder"
                                                []
                                                []
                                                AB
                                                "Expr",
                                              M.get_trait_method (|
                                                "core::convert::Into",
                                                Ty.associated_in_trait
                                                  "p3_air::air::AirBuilder"
                                                  []
                                                  []
                                                  AB
                                                  "Var",
                                                [],
                                                [
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Expr"
                                                ],
                                                "into",
                                                [],
                                                []
                                              |),
                                              [ M.read (| M.deref (| M.read (| elem |) |) |) ]
                                            |)
                                          |)
                                        |);
                                        M.borrow (|
                                          Pointer.Kind.Ref,
                                          M.deref (|
                                            M.borrow (|
                                              Pointer.Kind.Ref,
                                              M.alloc (|
                                                M.call_closure (|
                                                  Ty.associated_in_trait
                                                    "p3_air::air::AirBuilder"
                                                    []
                                                    []
                                                    AB
                                                    "Expr",
                                                  M.get_trait_method (|
                                                    "core::convert::Into",
                                                    Ty.associated_in_trait
                                                      "p3_air::air::AirBuilder"
                                                      []
                                                      []
                                                      AB
                                                      "Var",
                                                    [],
                                                    [
                                                      Ty.associated_in_trait
                                                        "p3_air::air::AirBuilder"
                                                        []
                                                        []
                                                        AB
                                                        "Expr"
                                                    ],
                                                    "into",
                                                    [],
                                                    []
                                                  |),
                                                  [
                                                    M.read (|
                                                      M.SubPointer.get_array_field (|
                                                        M.deref (| M.read (| c |) |),
                                                        M.call_closure (|
                                                          Ty.path "usize",
                                                          BinOp.Wrap.rem,
                                                          [
                                                            M.call_closure (|
                                                              Ty.path "usize",
                                                              BinOp.Wrap.sub,
                                                              [
                                                                M.call_closure (|
                                                                  Ty.path "usize",
                                                                  BinOp.Wrap.add,
                                                                  [
                                                                    Value.Integer
                                                                      IntegerKind.Usize
                                                                      32;
                                                                    M.call_closure (|
                                                                      Ty.path "usize",
                                                                      BinOp.Wrap.add,
                                                                      [
                                                                        M.read (| i |);
                                                                        Value.Integer
                                                                          IntegerKind.Usize
                                                                          16
                                                                      ]
                                                                    |)
                                                                  ]
                                                                |);
                                                                M.read (| shift |)
                                                              ]
                                                            |);
                                                            Value.Integer IntegerKind.Usize 32
                                                          ]
                                                        |)
                                                      |)
                                                    |)
                                                  ]
                                                |)
                                              |)
                                            |)
                                          |)
                                        |)
                                      ]
                                    |)))
                              ]
                            |)))
                        | _ => M.impossible "wrong number of arguments"
                        end))
                ]
              |)
            |) in
          let~ sum_16_32 :
              Ty.apply
                (Ty.path "*")
                []
                [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                M.get_function (|
                  "p3_air::utils::pack_bits_le",
                  [],
                  [
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr";
                    Ty.apply
                      (Ty.path "core::iter::adapters::map::Map")
                      []
                      [
                        Ty.apply
                          (Ty.path "core::iter::adapters::enumerate::Enumerate")
                          []
                          [
                            Ty.apply
                              (Ty.path "core::slice::iter::Iter")
                              []
                              [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var" ]
                          ];
                        Ty.function
                          [
                            Ty.tuple
                              [
                                Ty.tuple
                                  [
                                    Ty.path "usize";
                                    Ty.apply
                                      (Ty.path "&")
                                      []
                                      [
                                        Ty.associated_in_trait
                                          "p3_air::air::AirBuilder"
                                          []
                                          []
                                          AB
                                          "Var"
                                      ]
                                  ]
                              ]
                          ]
                          (Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr")
                      ]
                  ]
                |),
                [ M.read (| xor_shift_c_16_32 |) ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "p3_air::air::AirBuilder",
                  AB,
                  [],
                  [],
                  "assert_zeros",
                  [ Value.Integer IntegerKind.Usize 2 ],
                  [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ]
                |),
                [
                  M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| builder |) |) |);
                  Value.Array
                    [
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Sub",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "sub",
                          [],
                          []
                        |),
                        [
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| a |) |),
                              Value.Integer IntegerKind.Usize 0
                            |)
                          |);
                          M.read (| sum_0_16 |)
                        ]
                      |);
                      M.call_closure (|
                        Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr",
                        M.get_trait_method (|
                          "core::ops::arith::Sub",
                          Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Var",
                          [],
                          [ Ty.associated_in_trait "p3_air::air::AirBuilder" [] [] AB "Expr" ],
                          "sub",
                          [],
                          []
                        |),
                        [
                          M.read (|
                            M.SubPointer.get_array_field (|
                              M.deref (| M.read (| a |) |),
                              Value.Integer IntegerKind.Usize 1
                            |)
                          |);
                          M.read (| sum_16_32 |)
                        ]
                      |)
                    ]
                ]
              |)
            |) in
          M.alloc (| Value.Tuple [] |)
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_xor_32_shift :
    M.IsFunction.C "p3_air::utils::xor_32_shift" xor_32_shift.
  Admitted.
  Global Typeclasses Opaque xor_32_shift.
End utils.
