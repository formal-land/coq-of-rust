(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

Module poseidon2.
  Definition value_BN254_S_BOX_DEGREE (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    ltac:(M.monadic (M.alloc (| Value.Integer IntegerKind.U64 5 |))).
  
  Global Instance Instance_IsConstant_value_BN254_S_BOX_DEGREE :
    M.IsFunction.C "p3_bn254_fr::poseidon2::BN254_S_BOX_DEGREE" value_BN254_S_BOX_DEGREE.
  Admitted.
  Global Typeclasses Opaque value_BN254_S_BOX_DEGREE.
  
  Axiom Poseidon2Bn254 :
    forall (WIDTH : Value.t),
    (Ty.apply (Ty.path "p3_bn254_fr::poseidon2::Poseidon2Bn254") [ WIDTH ] []) =
      (Ty.apply
        (Ty.path "p3_poseidon2::Poseidon2")
        [
          WIDTH;
          M.unevaluated_const (mk_str (| "p3_bn254_fr_poseidon2_Poseidon2Bn254_discriminant" |))
        ]
        [
          Ty.path "p3_bn254_fr::Bn254Fr";
          Ty.apply
            (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
            [ WIDTH ]
            [ Ty.path "p3_bn254_fr::Bn254Fr" ];
          Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254"
        ]).
  
  Definition value_BN254_WIDTH (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    ltac:(M.monadic (M.alloc (| Value.Integer IntegerKind.Usize 3 |))).
  
  Global Instance Instance_IsConstant_value_BN254_WIDTH :
    M.IsFunction.C "p3_bn254_fr::poseidon2::BN254_WIDTH" value_BN254_WIDTH.
  Admitted.
  Global Typeclasses Opaque value_BN254_WIDTH.
  
  (* StructRecord
    {
      name := "Poseidon2InternalLayerBn254";
      const_params := [];
      ty_params := [];
      fields :=
        [
          ("internal_constants",
            Ty.apply
              (Ty.path "alloc::vec::Vec")
              []
              [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ])
        ];
    } *)
  
  Module Impl_core_fmt_Debug_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
    Definition Self : Ty.t := Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254".
    
    (* Debug *)
    Definition fmt (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self; f ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let f := M.alloc (| f |) in
          M.call_closure (|
            Ty.apply
              (Ty.path "core::result::Result")
              []
              [ Ty.tuple []; Ty.path "core::fmt::Error" ],
            M.get_associated_function (|
              Ty.path "core::fmt::Formatter",
              "debug_struct_field1_finish",
              [],
              []
            |),
            [
              M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| f |) |) |);
              M.borrow (|
                Pointer.Kind.Ref,
                M.deref (| mk_str (| "Poseidon2InternalLayerBn254" |) |)
              |);
              M.borrow (| Pointer.Kind.Ref, M.deref (| mk_str (| "internal_constants" |) |) |);
              (* Unsize *)
              M.pointer_coercion
                (M.borrow (|
                  Pointer.Kind.Ref,
                  M.deref (|
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.alloc (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.SubPointer.get_struct_record_field (|
                            M.deref (| M.read (| self |) |),
                            "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254",
                            "internal_constants"
                          |)
                        |)
                      |)
                    |)
                  |)
                |))
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::fmt::Debug"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [ ("fmt", InstanceField.Method fmt) ].
  End Impl_core_fmt_Debug_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
  
  Module Impl_core_clone_Clone_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
    Definition Self : Ty.t := Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254".
    
    (* Clone *)
    Definition clone (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          Value.StructRecord
            "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254"
            [
              ("internal_constants",
                M.call_closure (|
                  Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    []
                    [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ],
                  M.get_trait_method (|
                    "core::clone::Clone",
                    Ty.apply
                      (Ty.path "alloc::vec::Vec")
                      []
                      [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ],
                    [],
                    [],
                    "clone",
                    [],
                    []
                  |),
                  [
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.SubPointer.get_struct_record_field (|
                            M.deref (| M.read (| self |) |),
                            "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254",
                            "internal_constants"
                          |)
                        |)
                      |)
                    |)
                  ]
                |))
            ]))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::clone::Clone"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [ ("clone", InstanceField.Method clone) ].
  End Impl_core_clone_Clone_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
  
  Module Impl_core_default_Default_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
    Definition Self : Ty.t := Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254".
    
    (* Default *)
    Definition default (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [] =>
        ltac:(M.monadic
          (Value.StructRecord
            "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254"
            [
              ("internal_constants",
                M.call_closure (|
                  Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    []
                    [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ],
                  M.get_trait_method (|
                    "core::default::Default",
                    Ty.apply
                      (Ty.path "alloc::vec::Vec")
                      []
                      [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ],
                    [],
                    [],
                    "default",
                    [],
                    []
                  |),
                  []
                |))
            ]))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::default::Default"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [ ("default", InstanceField.Method default) ].
  End Impl_core_default_Default_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
  
  Module Impl_p3_poseidon2_internal_InternalLayerConstructor_p3_bn254_fr_Bn254Fr_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
    Definition Self : Ty.t := Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254".
    
    (*
        fn new_from_constants(internal_constants: Vec<Bn254Fr>) -> Self {
            Self { internal_constants }
        }
    *)
    Definition new_from_constants (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ internal_constants ] =>
        ltac:(M.monadic
          (let internal_constants := M.alloc (| internal_constants |) in
          Value.StructRecord
            "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254"
            [ ("internal_constants", M.read (| internal_constants |)) ]))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "p3_poseidon2::internal::InternalLayerConstructor"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) [ Ty.path "p3_bn254_fr::Bn254Fr" ]
        Self
        (* Instance *) [ ("new_from_constants", InstanceField.Method new_from_constants) ].
  End Impl_p3_poseidon2_internal_InternalLayerConstructor_p3_bn254_fr_Bn254Fr_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
  
  (*
  fn bn254_matmul_internal(state: &mut [Bn254Fr; 3]) {
      // We bracket in this way as the s-box is applied to state[0] so this lets us
      // begin this computation before the s-box finishes.
      let sum = state[0] + (state[1] + state[2]);
  
      state[0] += sum;
      state[1] += sum;
      state[2] = state[2].double() + sum;
  }
  *)
  Definition bn254_matmul_internal (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [], [ state ] =>
      ltac:(M.monadic
        (let state := M.alloc (| state |) in
        M.read (|
          let~ sum : Ty.apply (Ty.path "*") [] [ Ty.path "p3_bn254_fr::Bn254Fr" ] :=
            M.alloc (|
              M.call_closure (|
                Ty.path "p3_bn254_fr::Bn254Fr",
                M.get_trait_method (|
                  "core::ops::arith::Add",
                  Ty.path "p3_bn254_fr::Bn254Fr",
                  [],
                  [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                  "add",
                  [],
                  []
                |),
                [
                  M.read (|
                    M.SubPointer.get_array_field (|
                      M.deref (| M.read (| state |) |),
                      Value.Integer IntegerKind.Usize 0
                    |)
                  |);
                  M.call_closure (|
                    Ty.path "p3_bn254_fr::Bn254Fr",
                    M.get_trait_method (|
                      "core::ops::arith::Add",
                      Ty.path "p3_bn254_fr::Bn254Fr",
                      [],
                      [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                      "add",
                      [],
                      []
                    |),
                    [
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| state |) |),
                          Value.Integer IntegerKind.Usize 1
                        |)
                      |);
                      M.read (|
                        M.SubPointer.get_array_field (|
                          M.deref (| M.read (| state |) |),
                          Value.Integer IntegerKind.Usize 2
                        |)
                      |)
                    ]
                  |)
                ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "core::ops::arith::AddAssign",
                  Ty.path "p3_bn254_fr::Bn254Fr",
                  [],
                  [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                  "add_assign",
                  [],
                  []
                |),
                [
                  M.borrow (|
                    Pointer.Kind.MutRef,
                    M.SubPointer.get_array_field (|
                      M.deref (| M.read (| state |) |),
                      Value.Integer IntegerKind.Usize 0
                    |)
                  |);
                  M.read (| sum |)
                ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.call_closure (|
                Ty.tuple [],
                M.get_trait_method (|
                  "core::ops::arith::AddAssign",
                  Ty.path "p3_bn254_fr::Bn254Fr",
                  [],
                  [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                  "add_assign",
                  [],
                  []
                |),
                [
                  M.borrow (|
                    Pointer.Kind.MutRef,
                    M.SubPointer.get_array_field (|
                      M.deref (| M.read (| state |) |),
                      Value.Integer IntegerKind.Usize 1
                    |)
                  |);
                  M.read (| sum |)
                ]
              |)
            |) in
          let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
            M.alloc (|
              M.write (|
                M.SubPointer.get_array_field (|
                  M.deref (| M.read (| state |) |),
                  Value.Integer IntegerKind.Usize 2
                |),
                M.call_closure (|
                  Ty.path "p3_bn254_fr::Bn254Fr",
                  M.get_trait_method (|
                    "core::ops::arith::Add",
                    Ty.path "p3_bn254_fr::Bn254Fr",
                    [],
                    [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                    "add",
                    [],
                    []
                  |),
                  [
                    M.call_closure (|
                      Ty.path "p3_bn254_fr::Bn254Fr",
                      M.get_trait_method (|
                        "p3_field::field::PrimeCharacteristicRing",
                        Ty.path "p3_bn254_fr::Bn254Fr",
                        [],
                        [],
                        "double",
                        [],
                        []
                      |),
                      [
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.SubPointer.get_array_field (|
                            M.deref (| M.read (| state |) |),
                            Value.Integer IntegerKind.Usize 2
                          |)
                        |)
                      ]
                    |);
                    M.read (| sum |)
                  ]
                |)
              |)
            |) in
          M.alloc (| Value.Tuple [] |)
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_bn254_matmul_internal :
    M.IsFunction.C "p3_bn254_fr::poseidon2::bn254_matmul_internal" bn254_matmul_internal.
  Admitted.
  Global Typeclasses Opaque bn254_matmul_internal.
  
  Module Impl_p3_poseidon2_internal_InternalLayer_expr_expr_p3_bn254_fr_Bn254Fr_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
    Definition Self : Ty.t := Ty.path "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254".
    
    (*
        fn permute_state(&self, state: &mut [Bn254Fr; BN254_WIDTH]) {
            internal_permute_state(state, bn254_matmul_internal, &self.internal_constants)
        }
    *)
    Definition permute_state (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.call_closure (|
            Ty.tuple [],
            M.get_function (|
              "p3_poseidon2::internal::internal_permute_state",
              [ Value.Integer IntegerKind.Usize 3; Value.Integer IntegerKind.U64 5 ],
              [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "p3_bn254_fr::Bn254Fr" ]
            |),
            [
              M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |);
              (* ReifyFnPointer *)
              M.pointer_coercion
                (M.get_function (| "p3_bn254_fr::poseidon2::bn254_matmul_internal", [], [] |));
              M.borrow (|
                Pointer.Kind.Ref,
                M.deref (|
                  M.call_closure (|
                    Ty.apply
                      (Ty.path "&")
                      []
                      [ Ty.apply (Ty.path "slice") [] [ Ty.path "p3_bn254_fr::Bn254Fr" ] ],
                    M.get_trait_method (|
                      "core::ops::deref::Deref",
                      Ty.apply
                        (Ty.path "alloc::vec::Vec")
                        []
                        [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "alloc::alloc::Global" ],
                      [],
                      [],
                      "deref",
                      [],
                      []
                    |),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.deref (|
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_struct_record_field (|
                              M.deref (| M.read (| self |) |),
                              "p3_bn254_fr::poseidon2::Poseidon2InternalLayerBn254",
                              "internal_constants"
                            |)
                          |)
                        |)
                      |)
                    ]
                  |)
                |)
              |)
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "p3_poseidon2::internal::InternalLayer"
        (* Trait polymorphic consts *)
        [
          M.unevaluated_const (mk_str (| "p3_bn254_fr_poseidon2_discriminant" |));
          M.unevaluated_const (mk_str (| "p3_bn254_fr_poseidon2_discriminant" |))
        ]
        (* Trait polymorphic types *) [ Ty.path "p3_bn254_fr::Bn254Fr" ]
        Self
        (* Instance *) [ ("permute_state", InstanceField.Method permute_state) ].
  End Impl_p3_poseidon2_internal_InternalLayer_expr_expr_p3_bn254_fr_Bn254Fr_for_p3_bn254_fr_poseidon2_Poseidon2InternalLayerBn254.
  
  Axiom Poseidon2ExternalLayerBn254 :
    forall (WIDTH : Value.t),
    (Ty.apply (Ty.path "p3_bn254_fr::poseidon2::Poseidon2ExternalLayerBn254") [ WIDTH ] []) =
      (Ty.apply
        (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
        [ WIDTH ]
        [ Ty.path "p3_bn254_fr::Bn254Fr" ]).
  
  Module Impl_p3_poseidon2_external_ExternalLayerConstructor_WIDTH_p3_bn254_fr_Bn254Fr_for_p3_poseidon2_external_ExternalLayerConstants_WIDTH_p3_bn254_fr_Bn254Fr.
    Definition Self (WIDTH : Value.t) : Ty.t :=
      Ty.apply
        (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
        [ WIDTH ]
        [ Ty.path "p3_bn254_fr::Bn254Fr" ].
    
    (*
        fn new_from_constants(external_constants: Self) -> Self {
            external_constants
        }
    *)
    Definition new_from_constants
        (WIDTH : Value.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH in
      match ε, τ, α with
      | [], [], [ external_constants ] =>
        ltac:(M.monadic
          (let external_constants := M.alloc (| external_constants |) in
          M.read (| external_constants |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      forall (WIDTH : Value.t),
      M.IsTraitInstance
        "p3_poseidon2::external::ExternalLayerConstructor"
        (* Trait polymorphic consts *) [ WIDTH ]
        (* Trait polymorphic types *) [ Ty.path "p3_bn254_fr::Bn254Fr" ]
        (Self WIDTH)
        (* Instance *) [ ("new_from_constants", InstanceField.Method (new_from_constants WIDTH)) ].
  End Impl_p3_poseidon2_external_ExternalLayerConstructor_WIDTH_p3_bn254_fr_Bn254Fr_for_p3_poseidon2_external_ExternalLayerConstants_WIDTH_p3_bn254_fr_Bn254Fr.
  
  Module Impl_p3_poseidon2_external_ExternalLayer_WIDTH_expr_p3_bn254_fr_Bn254Fr_for_p3_poseidon2_external_ExternalLayerConstants_WIDTH_p3_bn254_fr_Bn254Fr.
    Definition Self (WIDTH : Value.t) : Ty.t :=
      Ty.apply
        (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
        [ WIDTH ]
        [ Ty.path "p3_bn254_fr::Bn254Fr" ].
    
    (*
        fn permute_state_initial(&self, state: &mut [Bn254Fr; WIDTH]) {
            external_initial_permute_state(
                state,
                self.get_initial_constants(),
                add_rc_and_sbox_generic,
                &HLMDSMat4,
            );
        }
    *)
    Definition permute_state_initial
        (WIDTH : Value.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH in
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.read (|
            let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
              M.alloc (|
                M.call_closure (|
                  Ty.tuple [],
                  M.get_function (|
                    "p3_poseidon2::external::external_initial_permute_state",
                    [ WIDTH ],
                    [
                      Ty.path "p3_bn254_fr::Bn254Fr";
                      Ty.path "p3_bn254_fr::Bn254Fr";
                      Ty.path "p3_poseidon2::external::HLMDSMat4"
                    ]
                  |),
                  [
                    M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |);
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.call_closure (|
                          Ty.apply
                            (Ty.path "&")
                            []
                            [
                              Ty.apply
                                (Ty.path "slice")
                                []
                                [
                                  Ty.apply
                                    (Ty.path "array")
                                    [ WIDTH ]
                                    [ Ty.path "p3_bn254_fr::Bn254Fr" ]
                                ]
                            ],
                          M.get_trait_method (|
                            "core::ops::deref::Deref",
                            Ty.apply
                              (Ty.path "alloc::vec::Vec")
                              []
                              [
                                Ty.apply
                                  (Ty.path "array")
                                  [ WIDTH ]
                                  [ Ty.path "p3_bn254_fr::Bn254Fr" ];
                                Ty.path "alloc::alloc::Global"
                              ],
                            [],
                            [],
                            "deref",
                            [],
                            []
                          |),
                          [
                            M.borrow (|
                              Pointer.Kind.Ref,
                              M.deref (|
                                M.call_closure (|
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "array")
                                            [ WIDTH ]
                                            [ Ty.path "p3_bn254_fr::Bn254Fr" ];
                                          Ty.path "alloc::alloc::Global"
                                        ]
                                    ],
                                  M.get_associated_function (|
                                    Ty.apply
                                      (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
                                      [ WIDTH ]
                                      [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                                    "get_initial_constants",
                                    [],
                                    []
                                  |),
                                  [ M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| self |) |) |)
                                  ]
                                |)
                              |)
                            |)
                          ]
                        |)
                      |)
                    |);
                    (* ReifyFnPointer *)
                    M.pointer_coercion
                      (M.get_function (|
                        "p3_poseidon2::generic::add_rc_and_sbox_generic",
                        [ Value.Integer IntegerKind.U64 5 ],
                        [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "p3_bn254_fr::Bn254Fr" ]
                      |));
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.alloc (| Value.StructTuple "p3_poseidon2::external::HLMDSMat4" [] |)
                        |)
                      |)
                    |)
                  ]
                |)
              |) in
            M.alloc (| Value.Tuple [] |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    (*
        fn permute_state_terminal(&self, state: &mut [Bn254Fr; WIDTH]) {
            external_terminal_permute_state(
                state,
                self.get_terminal_constants(),
                add_rc_and_sbox_generic,
                &HLMDSMat4,
            );
        }
    *)
    Definition permute_state_terminal
        (WIDTH : Value.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH in
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.read (|
            let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
              M.alloc (|
                M.call_closure (|
                  Ty.tuple [],
                  M.get_function (|
                    "p3_poseidon2::external::external_terminal_permute_state",
                    [ WIDTH ],
                    [
                      Ty.path "p3_bn254_fr::Bn254Fr";
                      Ty.path "p3_bn254_fr::Bn254Fr";
                      Ty.path "p3_poseidon2::external::HLMDSMat4"
                    ]
                  |),
                  [
                    M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |);
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.call_closure (|
                          Ty.apply
                            (Ty.path "&")
                            []
                            [
                              Ty.apply
                                (Ty.path "slice")
                                []
                                [
                                  Ty.apply
                                    (Ty.path "array")
                                    [ WIDTH ]
                                    [ Ty.path "p3_bn254_fr::Bn254Fr" ]
                                ]
                            ],
                          M.get_trait_method (|
                            "core::ops::deref::Deref",
                            Ty.apply
                              (Ty.path "alloc::vec::Vec")
                              []
                              [
                                Ty.apply
                                  (Ty.path "array")
                                  [ WIDTH ]
                                  [ Ty.path "p3_bn254_fr::Bn254Fr" ];
                                Ty.path "alloc::alloc::Global"
                              ],
                            [],
                            [],
                            "deref",
                            [],
                            []
                          |),
                          [
                            M.borrow (|
                              Pointer.Kind.Ref,
                              M.deref (|
                                M.call_closure (|
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "array")
                                            [ WIDTH ]
                                            [ Ty.path "p3_bn254_fr::Bn254Fr" ];
                                          Ty.path "alloc::alloc::Global"
                                        ]
                                    ],
                                  M.get_associated_function (|
                                    Ty.apply
                                      (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
                                      [ WIDTH ]
                                      [ Ty.path "p3_bn254_fr::Bn254Fr" ],
                                    "get_terminal_constants",
                                    [],
                                    []
                                  |),
                                  [ M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| self |) |) |)
                                  ]
                                |)
                              |)
                            |)
                          ]
                        |)
                      |)
                    |);
                    (* ReifyFnPointer *)
                    M.pointer_coercion
                      (M.get_function (|
                        "p3_poseidon2::generic::add_rc_and_sbox_generic",
                        [ Value.Integer IntegerKind.U64 5 ],
                        [ Ty.path "p3_bn254_fr::Bn254Fr"; Ty.path "p3_bn254_fr::Bn254Fr" ]
                      |));
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.alloc (| Value.StructTuple "p3_poseidon2::external::HLMDSMat4" [] |)
                        |)
                      |)
                    |)
                  ]
                |)
              |) in
            M.alloc (| Value.Tuple [] |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      forall (WIDTH : Value.t),
      M.IsTraitInstance
        "p3_poseidon2::external::ExternalLayer"
        (* Trait polymorphic consts *)
        [ WIDTH; M.unevaluated_const (mk_str (| "p3_bn254_fr_poseidon2_discriminant" |)) ]
        (* Trait polymorphic types *) [ Ty.path "p3_bn254_fr::Bn254Fr" ]
        (Self WIDTH)
        (* Instance *)
        [
          ("permute_state_initial", InstanceField.Method (permute_state_initial WIDTH));
          ("permute_state_terminal", InstanceField.Method (permute_state_terminal WIDTH))
        ].
  End Impl_p3_poseidon2_external_ExternalLayer_WIDTH_expr_p3_bn254_fr_Bn254Fr_for_p3_poseidon2_external_ExternalLayerConstants_WIDTH_p3_bn254_fr_Bn254Fr.
End poseidon2.
