(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

Module poseidon2.
  (* Trait *)
  (* Empty module 'InternalLayerBaseParameters' *)
  
  (* Trait *)
  (* Empty module 'InternalLayerParameters' *)
  
  Module Impl_p3_poseidon2_internal_InternalLayer_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_monty_31_data_traits_RelativelyPrimePower_FP_where_p3_monty_31_poseidon2_InternalLayerParameters_P2P_FP_WIDTH_D_p3_monty_31_monty_31_MontyField31_FP_for_p3_monty_31_no_packing_poseidon2_Poseidon2InternalLayerMonty31_WIDTH_FP_P2P.
    Definition Self (WIDTH D : Value.t) (FP P2P : Ty.t) : Ty.t :=
      Ty.apply
        (Ty.path "p3_monty_31::no_packing::poseidon2::Poseidon2InternalLayerMonty31")
        [ WIDTH ]
        [ FP; P2P ].
    
    (*
        fn permute_state(&self, state: &mut [MontyField31<FP>; WIDTH]) {
            self.internal_constants.iter().for_each(|rc| {
                state[0] += *rc;
                state[0] = state[0].injective_exp_n();
                let part_sum: MontyField31<FP> = state[1..].iter().copied().sum();
                let full_sum = part_sum + state[0];
                state[0] = part_sum - state[0];
                P2P::internal_layer_mat_mul(state, full_sum);
            })
        }
    *)
    Definition permute_state
        (WIDTH D : Value.t)
        (FP P2P : Ty.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH D FP P2P in
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.call_closure (|
            Ty.tuple [],
            M.get_trait_method (|
              "core::iter::traits::iterator::Iterator",
              Ty.apply
                (Ty.path "core::slice::iter::Iter")
                []
                [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ],
              [],
              [],
              "for_each",
              [],
              [
                Ty.function
                  [
                    Ty.tuple
                      [
                        Ty.apply
                          (Ty.path "&")
                          []
                          [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ]
                      ]
                  ]
                  (Ty.tuple [])
              ]
            |),
            [
              M.call_closure (|
                Ty.apply
                  (Ty.path "core::slice::iter::Iter")
                  []
                  [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ],
                M.get_associated_function (|
                  Ty.apply
                    (Ty.path "slice")
                    []
                    [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ],
                  "iter",
                  [],
                  []
                |),
                [
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.deref (|
                      M.call_closure (|
                        Ty.apply
                          (Ty.path "&")
                          []
                          [
                            Ty.apply
                              (Ty.path "slice")
                              []
                              [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ]
                          ],
                        M.get_trait_method (|
                          "core::ops::deref::Deref",
                          Ty.apply
                            (Ty.path "alloc::vec::Vec")
                            []
                            [
                              Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                              Ty.path "alloc::alloc::Global"
                            ],
                          [],
                          [],
                          "deref",
                          [],
                          []
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_struct_record_field (|
                              M.deref (| M.read (| self |) |),
                              "p3_monty_31::no_packing::poseidon2::Poseidon2InternalLayerMonty31",
                              "internal_constants"
                            |)
                          |)
                        ]
                      |)
                    |)
                  |)
                ]
              |);
              M.closure
                (fun γ =>
                  ltac:(M.monadic
                    match γ with
                    | [ α0 ] =>
                      ltac:(M.monadic
                        (M.match_operator (|
                          Ty.apply
                            (Ty.path "*")
                            []
                            [
                              Ty.function
                                [
                                  Ty.tuple
                                    [
                                      Ty.apply
                                        (Ty.path "&")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ]
                                        ]
                                    ]
                                ]
                                (Ty.tuple [])
                            ],
                          M.alloc (| α0 |),
                          [
                            fun γ =>
                              ltac:(M.monadic
                                (let rc := M.copy (| γ |) in
                                M.read (|
                                  let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                    M.alloc (|
                                      M.call_closure (|
                                        Ty.tuple [],
                                        M.get_trait_method (|
                                          "core::ops::arith::AddAssign",
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ],
                                          [],
                                          [
                                            Ty.apply
                                              (Ty.path "p3_monty_31::monty_31::MontyField31")
                                              []
                                              [ FP ]
                                          ],
                                          "add_assign",
                                          [],
                                          []
                                        |),
                                        [
                                          M.borrow (|
                                            Pointer.Kind.MutRef,
                                            M.SubPointer.get_array_field (|
                                              M.deref (| M.read (| state |) |),
                                              Value.Integer IntegerKind.Usize 0
                                            |)
                                          |);
                                          M.read (| M.deref (| M.read (| rc |) |) |)
                                        ]
                                      |)
                                    |) in
                                  let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                    M.alloc (|
                                      M.write (|
                                        M.SubPointer.get_array_field (|
                                          M.deref (| M.read (| state |) |),
                                          Value.Integer IntegerKind.Usize 0
                                        |),
                                        M.call_closure (|
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ],
                                          M.get_trait_method (|
                                            "p3_field::field::InjectiveMonomial",
                                            Ty.apply
                                              (Ty.path "p3_monty_31::monty_31::MontyField31")
                                              []
                                              [ FP ],
                                            [ D ],
                                            [],
                                            "injective_exp_n",
                                            [],
                                            []
                                          |),
                                          [
                                            M.borrow (|
                                              Pointer.Kind.Ref,
                                              M.SubPointer.get_array_field (|
                                                M.deref (| M.read (| state |) |),
                                                Value.Integer IntegerKind.Usize 0
                                              |)
                                            |)
                                          ]
                                        |)
                                      |)
                                    |) in
                                  let~ part_sum :
                                      Ty.apply
                                        (Ty.path "*")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ]
                                        ] :=
                                    M.alloc (|
                                      M.call_closure (|
                                        Ty.apply
                                          (Ty.path "p3_monty_31::monty_31::MontyField31")
                                          []
                                          [ FP ],
                                        M.get_trait_method (|
                                          "core::iter::traits::iterator::Iterator",
                                          Ty.apply
                                            (Ty.path "core::iter::adapters::copied::Copied")
                                            []
                                            [
                                              Ty.apply
                                                (Ty.path "core::slice::iter::Iter")
                                                []
                                                [
                                                  Ty.apply
                                                    (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                    []
                                                    [ FP ]
                                                ]
                                            ],
                                          [],
                                          [],
                                          "sum",
                                          [],
                                          [
                                            Ty.apply
                                              (Ty.path "p3_monty_31::monty_31::MontyField31")
                                              []
                                              [ FP ]
                                          ]
                                        |),
                                        [
                                          M.call_closure (|
                                            Ty.apply
                                              (Ty.path "core::iter::adapters::copied::Copied")
                                              []
                                              [
                                                Ty.apply
                                                  (Ty.path "core::slice::iter::Iter")
                                                  []
                                                  [
                                                    Ty.apply
                                                      (Ty.path
                                                        "p3_monty_31::monty_31::MontyField31")
                                                      []
                                                      [ FP ]
                                                  ]
                                              ],
                                            M.get_trait_method (|
                                              "core::iter::traits::iterator::Iterator",
                                              Ty.apply
                                                (Ty.path "core::slice::iter::Iter")
                                                []
                                                [
                                                  Ty.apply
                                                    (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                    []
                                                    [ FP ]
                                                ],
                                              [],
                                              [],
                                              "copied",
                                              [],
                                              [
                                                Ty.apply
                                                  (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                  []
                                                  [ FP ]
                                              ]
                                            |),
                                            [
                                              M.call_closure (|
                                                Ty.apply
                                                  (Ty.path "core::slice::iter::Iter")
                                                  []
                                                  [
                                                    Ty.apply
                                                      (Ty.path
                                                        "p3_monty_31::monty_31::MontyField31")
                                                      []
                                                      [ FP ]
                                                  ],
                                                M.get_associated_function (|
                                                  Ty.apply
                                                    (Ty.path "slice")
                                                    []
                                                    [
                                                      Ty.apply
                                                        (Ty.path
                                                          "p3_monty_31::monty_31::MontyField31")
                                                        []
                                                        [ FP ]
                                                    ],
                                                  "iter",
                                                  [],
                                                  []
                                                |),
                                                [
                                                  M.borrow (|
                                                    Pointer.Kind.Ref,
                                                    M.deref (|
                                                      M.call_closure (|
                                                        Ty.apply
                                                          (Ty.path "&")
                                                          []
                                                          [
                                                            Ty.apply
                                                              (Ty.path "slice")
                                                              []
                                                              [
                                                                Ty.apply
                                                                  (Ty.path
                                                                    "p3_monty_31::monty_31::MontyField31")
                                                                  []
                                                                  [ FP ]
                                                              ]
                                                          ],
                                                        M.get_trait_method (|
                                                          "core::ops::index::Index",
                                                          Ty.apply
                                                            (Ty.path "array")
                                                            [ WIDTH ]
                                                            [
                                                              Ty.apply
                                                                (Ty.path
                                                                  "p3_monty_31::monty_31::MontyField31")
                                                                []
                                                                [ FP ]
                                                            ],
                                                          [],
                                                          [
                                                            Ty.apply
                                                              (Ty.path
                                                                "core::ops::range::RangeFrom")
                                                              []
                                                              [ Ty.path "usize" ]
                                                          ],
                                                          "index",
                                                          [],
                                                          []
                                                        |),
                                                        [
                                                          M.borrow (|
                                                            Pointer.Kind.Ref,
                                                            M.deref (| M.read (| state |) |)
                                                          |);
                                                          Value.StructRecord
                                                            "core::ops::range::RangeFrom"
                                                            [
                                                              ("start",
                                                                Value.Integer IntegerKind.Usize 1)
                                                            ]
                                                        ]
                                                      |)
                                                    |)
                                                  |)
                                                ]
                                              |)
                                            ]
                                          |)
                                        ]
                                      |)
                                    |) in
                                  let~ full_sum :
                                      Ty.apply
                                        (Ty.path "*")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ]
                                        ] :=
                                    M.alloc (|
                                      M.call_closure (|
                                        Ty.apply
                                          (Ty.path "p3_monty_31::monty_31::MontyField31")
                                          []
                                          [ FP ],
                                        M.get_trait_method (|
                                          "core::ops::arith::Add",
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ],
                                          [],
                                          [
                                            Ty.apply
                                              (Ty.path "p3_monty_31::monty_31::MontyField31")
                                              []
                                              [ FP ]
                                          ],
                                          "add",
                                          [],
                                          []
                                        |),
                                        [
                                          M.read (| part_sum |);
                                          M.read (|
                                            M.SubPointer.get_array_field (|
                                              M.deref (| M.read (| state |) |),
                                              Value.Integer IntegerKind.Usize 0
                                            |)
                                          |)
                                        ]
                                      |)
                                    |) in
                                  let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                    M.alloc (|
                                      M.write (|
                                        M.SubPointer.get_array_field (|
                                          M.deref (| M.read (| state |) |),
                                          Value.Integer IntegerKind.Usize 0
                                        |),
                                        M.call_closure (|
                                          Ty.apply
                                            (Ty.path "p3_monty_31::monty_31::MontyField31")
                                            []
                                            [ FP ],
                                          M.get_trait_method (|
                                            "core::ops::arith::Sub",
                                            Ty.apply
                                              (Ty.path "p3_monty_31::monty_31::MontyField31")
                                              []
                                              [ FP ],
                                            [],
                                            [
                                              Ty.apply
                                                (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                []
                                                [ FP ]
                                            ],
                                            "sub",
                                            [],
                                            []
                                          |),
                                          [
                                            M.read (| part_sum |);
                                            M.read (|
                                              M.SubPointer.get_array_field (|
                                                M.deref (| M.read (| state |) |),
                                                Value.Integer IntegerKind.Usize 0
                                              |)
                                            |)
                                          ]
                                        |)
                                      |)
                                    |) in
                                  let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
                                    M.alloc (|
                                      M.call_closure (|
                                        Ty.tuple [],
                                        M.get_trait_method (|
                                          "p3_monty_31::poseidon2::InternalLayerBaseParameters",
                                          P2P,
                                          [ WIDTH ],
                                          [ FP ],
                                          "internal_layer_mat_mul",
                                          [],
                                          []
                                        |),
                                        [
                                          M.borrow (|
                                            Pointer.Kind.MutRef,
                                            M.deref (| M.read (| state |) |)
                                          |);
                                          M.read (| full_sum |)
                                        ]
                                      |)
                                    |) in
                                  M.alloc (| Value.Tuple [] |)
                                |)))
                          ]
                        |)))
                    | _ => M.impossible "wrong number of arguments"
                    end))
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      forall (WIDTH D : Value.t) (FP P2P : Ty.t),
      M.IsTraitInstance
        "p3_poseidon2::internal::InternalLayer"
        (* Trait polymorphic consts *) [ WIDTH; D ]
        (* Trait polymorphic types *)
        [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ]
        (Self WIDTH D FP P2P)
        (* Instance *) [ ("permute_state", InstanceField.Method (permute_state WIDTH D FP P2P)) ].
  End Impl_p3_poseidon2_internal_InternalLayer_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_monty_31_data_traits_RelativelyPrimePower_FP_where_p3_monty_31_poseidon2_InternalLayerParameters_P2P_FP_WIDTH_D_p3_monty_31_monty_31_MontyField31_FP_for_p3_monty_31_no_packing_poseidon2_Poseidon2InternalLayerMonty31_WIDTH_FP_P2P.
  
  Module Impl_p3_poseidon2_external_ExternalLayer_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_monty_31_data_traits_RelativelyPrimePower_FP_WIDTH_D_p3_monty_31_monty_31_MontyField31_FP_for_p3_monty_31_no_packing_poseidon2_Poseidon2ExternalLayerMonty31_WIDTH_FP.
    Definition Self (WIDTH D : Value.t) (FP : Ty.t) : Ty.t :=
      Ty.apply
        (Ty.path "p3_monty_31::no_packing::poseidon2::Poseidon2ExternalLayerMonty31")
        [ WIDTH ]
        [ FP ].
    
    (*
        fn permute_state_initial(&self, state: &mut [MontyField31<FP>; WIDTH]) {
            external_initial_permute_state(
                state,
                self.external_constants.get_initial_constants(),
                add_rc_and_sbox_generic,
                &MDSMat4,
            );
        }
    *)
    Definition permute_state_initial
        (WIDTH D : Value.t)
        (FP : Ty.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH D FP in
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.read (|
            let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
              M.alloc (|
                M.call_closure (|
                  Ty.tuple [],
                  M.get_function (|
                    "p3_poseidon2::external::external_initial_permute_state",
                    [ WIDTH ],
                    [
                      Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                      Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                      Ty.path "p3_poseidon2::external::MDSMat4"
                    ]
                  |),
                  [
                    M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |);
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.call_closure (|
                          Ty.apply
                            (Ty.path "&")
                            []
                            [
                              Ty.apply
                                (Ty.path "slice")
                                []
                                [
                                  Ty.apply
                                    (Ty.path "array")
                                    [ WIDTH ]
                                    [
                                      Ty.apply
                                        (Ty.path "p3_monty_31::monty_31::MontyField31")
                                        []
                                        [ FP ]
                                    ]
                                ]
                            ],
                          M.get_trait_method (|
                            "core::ops::deref::Deref",
                            Ty.apply
                              (Ty.path "alloc::vec::Vec")
                              []
                              [
                                Ty.apply
                                  (Ty.path "array")
                                  [ WIDTH ]
                                  [
                                    Ty.apply
                                      (Ty.path "p3_monty_31::monty_31::MontyField31")
                                      []
                                      [ FP ]
                                  ];
                                Ty.path "alloc::alloc::Global"
                              ],
                            [],
                            [],
                            "deref",
                            [],
                            []
                          |),
                          [
                            M.borrow (|
                              Pointer.Kind.Ref,
                              M.deref (|
                                M.call_closure (|
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "array")
                                            [ WIDTH ]
                                            [
                                              Ty.apply
                                                (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                []
                                                [ FP ]
                                            ];
                                          Ty.path "alloc::alloc::Global"
                                        ]
                                    ],
                                  M.get_associated_function (|
                                    Ty.apply
                                      (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
                                      [ WIDTH ]
                                      [
                                        Ty.apply
                                          (Ty.path "p3_monty_31::monty_31::MontyField31")
                                          []
                                          [ FP ]
                                      ],
                                    "get_initial_constants",
                                    [],
                                    []
                                  |),
                                  [
                                    M.borrow (|
                                      Pointer.Kind.Ref,
                                      M.SubPointer.get_struct_record_field (|
                                        M.deref (| M.read (| self |) |),
                                        "p3_monty_31::no_packing::poseidon2::Poseidon2ExternalLayerMonty31",
                                        "external_constants"
                                      |)
                                    |)
                                  ]
                                |)
                              |)
                            |)
                          ]
                        |)
                      |)
                    |);
                    (* ReifyFnPointer *)
                    M.pointer_coercion
                      (M.get_function (|
                        "p3_poseidon2::generic::add_rc_and_sbox_generic",
                        [ D ],
                        [
                          Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                          Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ]
                        ]
                      |));
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.alloc (| Value.StructTuple "p3_poseidon2::external::MDSMat4" [] |)
                        |)
                      |)
                    |)
                  ]
                |)
              |) in
            M.alloc (| Value.Tuple [] |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    (*
        fn permute_state_terminal(&self, state: &mut [MontyField31<FP>; WIDTH]) {
            external_terminal_permute_state(
                state,
                self.external_constants.get_terminal_constants(),
                add_rc_and_sbox_generic,
                &MDSMat4,
            );
        }
    *)
    Definition permute_state_terminal
        (WIDTH D : Value.t)
        (FP : Ty.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH D FP in
      match ε, τ, α with
      | [], [], [ self; state ] =>
        ltac:(M.monadic
          (let self := M.alloc (| self |) in
          let state := M.alloc (| state |) in
          M.read (|
            let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
              M.alloc (|
                M.call_closure (|
                  Ty.tuple [],
                  M.get_function (|
                    "p3_poseidon2::external::external_terminal_permute_state",
                    [ WIDTH ],
                    [
                      Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                      Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                      Ty.path "p3_poseidon2::external::MDSMat4"
                    ]
                  |),
                  [
                    M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |);
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.call_closure (|
                          Ty.apply
                            (Ty.path "&")
                            []
                            [
                              Ty.apply
                                (Ty.path "slice")
                                []
                                [
                                  Ty.apply
                                    (Ty.path "array")
                                    [ WIDTH ]
                                    [
                                      Ty.apply
                                        (Ty.path "p3_monty_31::monty_31::MontyField31")
                                        []
                                        [ FP ]
                                    ]
                                ]
                            ],
                          M.get_trait_method (|
                            "core::ops::deref::Deref",
                            Ty.apply
                              (Ty.path "alloc::vec::Vec")
                              []
                              [
                                Ty.apply
                                  (Ty.path "array")
                                  [ WIDTH ]
                                  [
                                    Ty.apply
                                      (Ty.path "p3_monty_31::monty_31::MontyField31")
                                      []
                                      [ FP ]
                                  ];
                                Ty.path "alloc::alloc::Global"
                              ],
                            [],
                            [],
                            "deref",
                            [],
                            []
                          |),
                          [
                            M.borrow (|
                              Pointer.Kind.Ref,
                              M.deref (|
                                M.call_closure (|
                                  Ty.apply
                                    (Ty.path "&")
                                    []
                                    [
                                      Ty.apply
                                        (Ty.path "alloc::vec::Vec")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "array")
                                            [ WIDTH ]
                                            [
                                              Ty.apply
                                                (Ty.path "p3_monty_31::monty_31::MontyField31")
                                                []
                                                [ FP ]
                                            ];
                                          Ty.path "alloc::alloc::Global"
                                        ]
                                    ],
                                  M.get_associated_function (|
                                    Ty.apply
                                      (Ty.path "p3_poseidon2::external::ExternalLayerConstants")
                                      [ WIDTH ]
                                      [
                                        Ty.apply
                                          (Ty.path "p3_monty_31::monty_31::MontyField31")
                                          []
                                          [ FP ]
                                      ],
                                    "get_terminal_constants",
                                    [],
                                    []
                                  |),
                                  [
                                    M.borrow (|
                                      Pointer.Kind.Ref,
                                      M.SubPointer.get_struct_record_field (|
                                        M.deref (| M.read (| self |) |),
                                        "p3_monty_31::no_packing::poseidon2::Poseidon2ExternalLayerMonty31",
                                        "external_constants"
                                      |)
                                    |)
                                  ]
                                |)
                              |)
                            |)
                          ]
                        |)
                      |)
                    |);
                    (* ReifyFnPointer *)
                    M.pointer_coercion
                      (M.get_function (|
                        "p3_poseidon2::generic::add_rc_and_sbox_generic",
                        [ D ],
                        [
                          Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ];
                          Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ]
                        ]
                      |));
                    M.borrow (|
                      Pointer.Kind.Ref,
                      M.deref (|
                        M.borrow (|
                          Pointer.Kind.Ref,
                          M.alloc (| Value.StructTuple "p3_poseidon2::external::MDSMat4" [] |)
                        |)
                      |)
                    |)
                  ]
                |)
              |) in
            M.alloc (| Value.Tuple [] |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      forall (WIDTH D : Value.t) (FP : Ty.t),
      M.IsTraitInstance
        "p3_poseidon2::external::ExternalLayer"
        (* Trait polymorphic consts *) [ WIDTH; D ]
        (* Trait polymorphic types *)
        [ Ty.apply (Ty.path "p3_monty_31::monty_31::MontyField31") [] [ FP ] ]
        (Self WIDTH D FP)
        (* Instance *)
        [
          ("permute_state_initial", InstanceField.Method (permute_state_initial WIDTH D FP));
          ("permute_state_terminal", InstanceField.Method (permute_state_terminal WIDTH D FP))
        ].
  End Impl_p3_poseidon2_external_ExternalLayer_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_monty_31_data_traits_RelativelyPrimePower_FP_WIDTH_D_p3_monty_31_monty_31_MontyField31_FP_for_p3_monty_31_no_packing_poseidon2_Poseidon2ExternalLayerMonty31_WIDTH_FP.
  
  (* StructRecord
    {
      name := "GenericPoseidon2LinearLayersMonty31";
      const_params := [];
      ty_params := [ "FP"; "ILBP" ];
      fields :=
        [
          ("_phantom1", Ty.apply (Ty.path "core::marker::PhantomData") [] [ FP ]);
          ("_phantom2", Ty.apply (Ty.path "core::marker::PhantomData") [] [ ILBP ])
        ];
    } *)
  
  Module Impl_p3_poseidon2_generic_GenericPoseidon2LinearLayers_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_field_field_Algebra_A_p3_monty_31_monty_31_MontyField31_FP_where_p3_monty_31_poseidon2_InternalLayerBaseParameters_ILBP_FP_WIDTH_A_for_p3_monty_31_poseidon2_GenericPoseidon2LinearLayersMonty31_FP_ILBP.
    Definition Self (WIDTH : Value.t) (FP A ILBP : Ty.t) : Ty.t :=
      Ty.apply
        (Ty.path "p3_monty_31::poseidon2::GenericPoseidon2LinearLayersMonty31")
        []
        [ FP; ILBP ].
    
    (*
        fn internal_linear_layer(state: &mut [A; WIDTH]) {
            ILBP::generic_internal_linear_layer(state);
        }
    *)
    Definition internal_linear_layer
        (WIDTH : Value.t)
        (FP A ILBP : Ty.t)
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      let Self : Ty.t := Self WIDTH FP A ILBP in
      match ε, τ, α with
      | [], [], [ state ] =>
        ltac:(M.monadic
          (let state := M.alloc (| state |) in
          M.read (|
            let~ _ : Ty.apply (Ty.path "*") [] [ Ty.tuple [] ] :=
              M.alloc (|
                M.call_closure (|
                  Ty.tuple [],
                  M.get_trait_method (|
                    "p3_monty_31::poseidon2::InternalLayerBaseParameters",
                    ILBP,
                    [ WIDTH ],
                    [ FP ],
                    "generic_internal_linear_layer",
                    [],
                    [ A ]
                  |),
                  [ M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| state |) |) |) ]
                |)
              |) in
            M.alloc (| Value.Tuple [] |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      forall (WIDTH : Value.t) (FP A ILBP : Ty.t),
      M.IsTraitInstance
        "p3_poseidon2::generic::GenericPoseidon2LinearLayers"
        (* Trait polymorphic consts *) [ WIDTH ]
        (* Trait polymorphic types *) [ A ]
        (Self WIDTH FP A ILBP)
        (* Instance *)
        [ ("internal_linear_layer", InstanceField.Method (internal_linear_layer WIDTH FP A ILBP)) ].
  End Impl_p3_poseidon2_generic_GenericPoseidon2LinearLayers_where_p3_monty_31_data_traits_FieldParameters_FP_where_p3_field_field_Algebra_A_p3_monty_31_monty_31_MontyField31_FP_where_p3_monty_31_poseidon2_InternalLayerBaseParameters_ILBP_FP_WIDTH_A_for_p3_monty_31_poseidon2_GenericPoseidon2LinearLayersMonty31_FP_ILBP.
End poseidon2.
