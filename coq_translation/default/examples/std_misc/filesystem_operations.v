(* Generated by coq-of-rust *)
Require Import CoqOfRust.CoqOfRust.

Definition cat
    `{H' : State.Trait}
    (path : ref std.path.Path)
    : M (H := H') (std.io.error.Result alloc.string.String) :=
  let* f :=
    let* α0 := (std.fs.File _)::["open"] path in
    let* α1 := α0.["branch"] in
    match α1 with
    | LanguageItem.Break residual =>
      let* α0 := residual.["from_residual"] in
      Return α0
    | LanguageItem.Continue val => Pure val
    end in
  let* s := (alloc.string.String _)::["new"] in
  let* α0 := f.["read_to_string"] (addr_of s) in
  match α0 with
  | core.result.Result.Ok _ => Pure (core.result.Result.Ok s)
  | core.result.Result.Err e => Pure (core.result.Result.Err e)
  end.

Definition echo
    `{H' : State.Trait}
    (s : ref str)
    (path : ref std.path.Path)
    : M (H := H') (std.io.error.Result unit) :=
  let* f :=
    let* α0 := (std.fs.File _)::["create"] path in
    let* α1 := α0.["branch"] in
    match α1 with
    | LanguageItem.Break residual =>
      let* α0 := residual.["from_residual"] in
      Return α0
    | LanguageItem.Continue val => Pure val
    end in
  let* α0 := s.["as_bytes"] in
  f.["write_all"] α0.

Definition touch
    `{H' : State.Trait}
    (path : ref std.path.Path)
    : M (H := H') (std.io.error.Result unit) :=
  let* α0 := (std.fs.OpenOptions _)::["new"] in
  let* α1 := α0.["create"] true in
  let* α2 := α1.["write"] true in
  let* α3 := α2.["open"] path in
  match α3 with
  | core.result.Result.Ok _ => Pure (core.result.Result.Ok tt)
  | core.result.Result.Err e => Pure (core.result.Result.Err e)
  end.

(* #[allow(dead_code)] - function was ignored by the compiler *)
Definition main `{H' : State.Trait} : M (H := H') unit :=
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"] (addr_of [ "`mkdir a`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := std.fs.create_dir "a" in
    match α0 with
    | core.result.Result.Err why =>
      let* _ :=
        let* α0 := why.["kind"] in
        let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
        let* α2 :=
          (format_arguments _)::["new_v1"]
            (addr_of [ "! "; "
" ])
            (addr_of [ α1 ]) in
        std.io.stdio._print α2 in
      Pure tt
    | core.result.Result.Ok _ => Pure tt
    end in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"]
          (addr_of [ "`echo hello > a/b.txt`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := (std.path.Path _)::["new"] "a/b.txt" in
    let* α1 := filesystem_operations.echo "hello" (addr_of α0) in
    α1.["unwrap_or_else"]
      (fun why =>
        let* _ :=
          let* _ :=
            let* α0 := why.["kind"] in
            let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
            let* α2 :=
              (format_arguments _)::["new_v1"]
                (addr_of [ "! "; "
" ])
                (addr_of [ α1 ]) in
            std.io.stdio._print α2 in
          Pure tt in
        Pure tt) in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"] (addr_of [ "`mkdir -p a/c/d`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := std.fs.create_dir_all "a/c/d" in
    α0.["unwrap_or_else"]
      (fun why =>
        let* _ :=
          let* _ :=
            let* α0 := why.["kind"] in
            let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
            let* α2 :=
              (format_arguments _)::["new_v1"]
                (addr_of [ "! "; "
" ])
                (addr_of [ α1 ]) in
            std.io.stdio._print α2 in
          Pure tt in
        Pure tt) in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"]
          (addr_of [ "`touch a/c/e.txt`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := (std.path.Path _)::["new"] "a/c/e.txt" in
    let* α1 := filesystem_operations.touch (addr_of α0) in
    α1.["unwrap_or_else"]
      (fun why =>
        let* _ :=
          let* _ :=
            let* α0 := why.["kind"] in
            let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
            let* α2 :=
              (format_arguments _)::["new_v1"]
                (addr_of [ "! "; "
" ])
                (addr_of [ α1 ]) in
            std.io.stdio._print α2 in
          Pure tt in
        Pure tt) in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"]
          (addr_of [ "`ln -s ../b.txt a/c/b.txt`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    if (true : bool) then
      let* _ :=
        let* α0 := std.os.unix.fs.symlink "../b.txt" "a/c/b.txt" in
        α0.["unwrap_or_else"]
          (fun why =>
            let* _ :=
              let* _ :=
                let* α0 := why.["kind"] in
                let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
                let* α2 :=
                  (format_arguments _)::["new_v1"]
                    (addr_of [ "! "; "
" ])
                    (addr_of [ α1 ]) in
                std.io.stdio._print α2 in
              Pure tt in
            Pure tt) in
      Pure tt
    else
      Pure tt in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"] (addr_of [ "`cat a/c/b.txt`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := (std.path.Path _)::["new"] "a/c/b.txt" in
    let* α1 := filesystem_operations.cat (addr_of α0) in
    match α1 with
    | core.result.Result.Err why =>
      let* _ :=
        let* α0 := why.["kind"] in
        let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
        let* α2 :=
          (format_arguments _)::["new_v1"]
            (addr_of [ "! "; "
" ])
            (addr_of [ α1 ]) in
        std.io.stdio._print α2 in
      Pure tt
    | core.result.Result.Ok s =>
      let* _ :=
        let* α0 := (format_argument _)::["new_display"] (addr_of s) in
        let* α1 :=
          (format_arguments _)::["new_v1"]
            (addr_of [ "> "; "
" ])
            (addr_of [ α0 ]) in
        std.io.stdio._print α1 in
      Pure tt
    end in
  let* _ :=
    let* _ :=
      let* α0 := (format_arguments _)::["new_const"] (addr_of [ "`ls a`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := std.fs.read_dir "a" in
    match α0 with
    | core.result.Result.Err why =>
      let* _ :=
        let* α0 := why.["kind"] in
        let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
        let* α2 :=
          (format_arguments _)::["new_v1"]
            (addr_of [ "! "; "
" ])
            (addr_of [ α1 ]) in
        std.io.stdio._print α2 in
      Pure tt
    | core.result.Result.Ok paths =>
      let* α0 := paths.["into_iter"] in
      match α0 with
      | iter =>
        loop
          (let* _ :=
            let* α0 := (addr_of iter).["next"] in
            match α0 with
            | core.option.Option.None  => Break
            | core.option.Option.Some path =>
              let* _ :=
                let* _ :=
                  let* α0 := path.["unwrap"] in
                  let* α1 := α0.["path"] in
                  let* α2 := (format_argument _)::["new_debug"] (addr_of α1) in
                  let* α3 :=
                    (format_arguments _)::["new_v1"]
                      (addr_of [ "> "; "
" ])
                      (addr_of [ α2 ]) in
                  std.io.stdio._print α3 in
                Pure tt in
              Pure tt
            end in
          Pure tt)
      end
    end in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"] (addr_of [ "`rm a/c/e.txt`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := std.fs.remove_file "a/c/e.txt" in
    α0.["unwrap_or_else"]
      (fun why =>
        let* _ :=
          let* _ :=
            let* α0 := why.["kind"] in
            let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
            let* α2 :=
              (format_arguments _)::["new_v1"]
                (addr_of [ "! "; "
" ])
                (addr_of [ α1 ]) in
            std.io.stdio._print α2 in
          Pure tt in
        Pure tt) in
  let* _ :=
    let* _ :=
      let* α0 :=
        (format_arguments _)::["new_const"] (addr_of [ "`rmdir a/c/d`
" ]) in
      std.io.stdio._print α0 in
    Pure tt in
  let* _ :=
    let* α0 := std.fs.remove_dir "a/c/d" in
    α0.["unwrap_or_else"]
      (fun why =>
        let* _ :=
          let* _ :=
            let* α0 := why.["kind"] in
            let* α1 := (format_argument _)::["new_debug"] (addr_of α0) in
            let* α2 :=
              (format_arguments _)::["new_v1"]
                (addr_of [ "! "; "
" ])
                (addr_of [ α1 ]) in
            std.io.stdio._print α2 in
          Pure tt in
        Pure tt) in
  Pure tt.
